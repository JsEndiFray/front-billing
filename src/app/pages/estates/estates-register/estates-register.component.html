<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Registrar Propiedad</h1>
    <p class="subtitle">Crear nueva propiedad inmobiliaria en el sistema</p>
  </div>

  <!-- === INDICADOR DE PASOS === -->
  <div class="stepper-indicator">

    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <div class="step-circle">1</div>
      <span>Propiedad</span>
    </div>

    <div class="step-line" [class.completed]="currentStep > 1"></div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <div class="step-circle">2</div>
      <span>Propietarios</span>
    </div>

    <div class="step-line" [class.completed]="currentStep > 2"></div>
    <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
      <div class="step-circle">3</div>
      <span>Resumen</span>
    </div>

  </div>

  <!-- === PASO 1: FORMULARIO DE PROPIEDAD === -->
  @if (currentStep === 1) {
    <form [formGroup]="estateForm" (ngSubmit)="createEstate()">
      <!-- Secci√≥n: Identificaci√≥n de la propiedad -->
      <div class="section">
        <h2 class="section-title">üè† Identificaci√≥n de la Propiedad</h2>
        <div class="form-grid">

          <div class="form-field form-field-full">
            <label for="referencia" class="form-label">Referencia Catastral *</label>
            <input
              type="text"
              formControlName="cadastral_reference"
              id="referencia"
              placeholder="Ej: 1234567AB0001XX"
              class="form-input reference-input"
              required>
          </div>

          <div class="form-field">
            <label for="price" class="form-label">Precio (‚Ç¨) *</label>
            <input
              type="number"
              formControlName="price"
              id="price"
              placeholder="250000"
              class="form-input price-input"
              min="0"
              step="1000"
              required>
          </div>

          <div class="form-field">
            <label for="surface" class="form-label">Superficie (m¬≤) *</label>
            <input
              type="number"
              formControlName="surface"
              id="surface"
              placeholder="120"
              class="form-input surface-input"
              min="1"
              step="1"
              required>
          </div>

        </div>
      </div>

      <!-- Secci√≥n: Direcci√≥n -->
      <div class="section">
        <h2 class="section-title">üìç Ubicaci√≥n</h2>
        <div class="form-grid">

          <div class="form-field form-field-full">
            <label for="address" class="form-label">Direcci√≥n *</label>
            <input
              type="text"
              formControlName="address"
              id="address"
              placeholder="Calle Principal 123, 2¬∫ A"
              class="form-input"
              autocomplete="street-address"
              required>
          </div>

          <div class="form-field">
            <label for="postal_code" class="form-label">C√≥digo Postal *</label>
            <input
              type="text"
              formControlName="postal_code"
              id="postal_code"
              placeholder="28001"
              class="form-input postal-input"
              autocomplete="postal-code"
              pattern="[0-9]{5}"
              maxlength="5"
              required>
          </div>

          <div class="form-field">
            <label for="location" class="form-label">Localidad *</label>
            <input
              type="text"
              formControlName="location"
              id="location"
              placeholder="Madrid"
              class="form-input"
              autocomplete="address-level2"
              required>
          </div>

          <div class="form-field">
            <label for="province" class="form-label">Provincia *</label>
            <input
              type="text"
              formControlName="province"
              id="province"
              placeholder="Madrid"
              class="form-input"
              autocomplete="address-level1"
              required>
          </div>

          <div class="form-field">
            <label for="country" class="form-label">Pa√≠s *</label>
            <input
              type="text"
              formControlName="country"
              id="country"
              placeholder="Espa√±a"
              class="form-input"
              autocomplete="country-name"
              value="Espa√±a"
              required>
          </div>

        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="actions-section">
        @if (createdEstate) {
          <button type="button" class="primary-btn" (click)="updateExistingEstate()">
            üîÑ Actualizar Propiedad
          </button>
        } @else {
          <button type="submit" class="primary-btn">
            üè† Registrar Propiedad
          </button>
        }
        <button type="button" class="secondary-btn" (click)="goBack()">
          ‚Üê Volver al Listado
        </button>
      </div>

    </form>
  }




  <!-- === PASO 2: ASIGNAR PROPIETARIOS === -->
  @if (currentStep === 2) {
    <form [formGroup]="ownersForm">
      <div class="owner-card">
        <div class="owner-card-header">
          <h5>Paso 2: Asignar Propietarios</h5>
          <small>Los porcentajes deben sumar exactamente 100%</small>
        </div>

        <div class="owner-card-body">
          <!-- FormArray de propietarios -->
          <div formArrayName="selectedOwners">
            @for (ownerGroup of selectedOwnersArray.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="owner-row">

                <!-- Selector de Propietario -->
                <div class="owner-field">
                  <label>Propietario {{ i + 1 }}</label>
                  <select
                    formControlName="owner"
                    class="form-input"
                    [class.input-error]="ownerGroup.get('owner')?.invalid && ownerGroup.get('owner')?.touched">

                    <option value="">Seleccionar propietario...</option>

                    @for (owner of getAvailableOwnersForSelect(i); track owner.id) {
                      <option [ngValue]="owner">
                        {{ owner.name }} {{ owner.lastname }} - {{ owner.identification }}
                      </option>
                    }
                  </select>

                  <!-- Errores del selector -->
                  @if (ownerGroup.get('owner')?.invalid && ownerGroup.get('owner')?.touched) {
                    <div class="error-message">
                      Debes seleccionar un propietario
                    </div>
                  }

                  <!-- Advertencia de duplicado -->
                  @if (ownerGroup.get('owner')?.value && isOwnerAlreadySelected(ownerGroup.get('owner')?.value?.id, i)) {
                    <div class="warning-message">
                      ‚ö†Ô∏è Este propietario ya est√° seleccionado
                    </div>
                  }
                </div>

                <!-- Campo de Porcentaje -->
                <div class="percentage-field">
                  <label>Porcentaje (%)</label>
                  <input
                    type="number"
                    formControlName="percentage"
                    class="form-input"
                    min="0.01"
                    max="100"
                    step="0.01"
                    placeholder="0.00"
                    [class.input-error]="ownerGroup.get('percentage')?.invalid && ownerGroup.get('percentage')?.touched">

                  <!-- Errores del porcentaje -->
                  @if (ownerGroup.get('percentage')?.invalid && ownerGroup.get('percentage')?.touched) {
                    <div class="error-message">
                      @if (ownerGroup.get('percentage')?.errors?.['required']) {
                        <span>El porcentaje es obligatorio</span>
                      }
                      @if (ownerGroup.get('percentage')?.errors?.['min']) {
                        <span>Debe ser mayor a 0</span>
                      }
                      @if (ownerGroup.get('percentage')?.errors?.['max']) {
                        <span>No puede exceder 100%</span>
                      }
                      @if (ownerGroup.get('percentage')?.errors?.['totalNotValid']) {
                        <span>Los porcentajes deben sumar 100% (actual: {{ getTotalPercentage() }}%)</span>
                      }
                    </div>
                  }
                </div>




                <!-- Botones -->
                <div class="owner-actions">
                  <button type="button" class="btn-success-small" (click)="openCreateOwnerForm(i)">+ Nuevo</button>
                  <button type="button" class="btn-danger-small" (click)="removeOwner(i)" [disabled]="selectedOwnersArray.length <= 1">üóëÔ∏è Eliminar</button>
                </div>
              </div>
            }
          </div>



          <!-- Resumen de porcentajes -->
          <div class="percentage-summary">
            <div class="summary-info">
              <strong>Total asignado: {{ getTotalPercentage() }}%</strong>
              @if (getTotalPercentage() === 100) {
                <span class="status-perfect">‚úÖ Perfecto</span>
              } @else if (getTotalPercentage() > 100) {
                <span class="status-error">‚ùå Excede 100%</span>
              } @else {
                <span class="status-warning">‚ö†Ô∏è Falta {{ 100 - getTotalPercentage() }}%</span>
              }
            </div>
            <div class="add-owner-section">
              <button
                type="button"
                class="btn-primary"
                (click)="addOwner()">
                + Agregar Propietario
              </button>
            </div>
          </div>




          <!-- Botones de navegaci√≥n -->
          <div class="navigation-buttons">
            <button
              type="button"
              class="btn-secondary"
              (click)="goBackToStep1()">
              ‚Üê Volver a Propiedad
            </button>
            <button
              type="button"
              class="btn-success"
              (click)="continueToSummary()"
              [disabled]="!canContinueToStep3()">
              Continuar al Resumen ‚Üí
            </button>
          </div>
        </div>
      </div>




      <!-- Modal/Formulario para crear nuevo propietario - OPTIMIZADO -->
      @if (showCreateOwnerForm) {
        <div class="create-owner-modal" [formGroup]="newOwnerForm">
          <div class="modal-header">
            <h6>Crear Nuevo Propietario</h6>
          </div>
          <div class="modal-body">
            <div class="owner-form-grid">
              <div class="form-group">
                <label>Nombre *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="name"
                  placeholder="Nombre"
                  [class.input-error]="newOwnerForm.get('name')?.invalid && newOwnerForm.get('name')?.touched">
                @if (newOwnerForm.get('name')?.invalid && newOwnerForm.get('name')?.touched) {
                  <div class="error-message">El nombre es obligatorio</div>
                }
              </div>

              <div class="form-group">
                <label>Apellidos *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="lastname"
                  placeholder="Apellidos"
                  [class.input-error]="newOwnerForm.get('lastname')?.invalid && newOwnerForm.get('lastname')?.touched">
                @if (newOwnerForm.get('lastname')?.invalid && newOwnerForm.get('lastname')?.touched) {
                  <div class="error-message">Los apellidos son obligatorios</div>
                }
              </div>

              <div class="form-group">
                <label>Identificaci√≥n *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="identification"
                  placeholder="DNI/NIE/Pasaporte"
                  [class.input-error]="newOwnerForm.get('identification')?.invalid && newOwnerForm.get('identification')?.touched">
                @if (newOwnerForm.get('identification')?.invalid && newOwnerForm.get('identification')?.touched) {
                  <div class="error-message">La identificaci√≥n es obligatoria</div>
                }
              </div>

              <div class="form-group">
                <label>Email *</label>
                <input
                  type="email"
                  class="form-input"
                  formControlName="email"
                  placeholder="correo@ejemplo.com"
                  [class.input-error]="newOwnerForm.get('email')?.invalid && newOwnerForm.get('email')?.touched">
                @if (newOwnerForm.get('email')?.invalid && newOwnerForm.get('email')?.touched) {
                  <div class="error-message">
                    @if (newOwnerForm.get('email')?.errors?.['required']) {
                      <span>El email es obligatorio</span>
                    }
                    @if (newOwnerForm.get('email')?.errors?.['email']) {
                      <span>Formato de email inv√°lido</span>
                    }
                  </div>
                }
              </div>

              <div class="form-group">
                <label>Tel√©fono *</label>
                <input
                  type="tel"
                  class="form-input"
                  formControlName="phone"
                  placeholder="600123456"
                  [class.input-error]="newOwnerForm.get('phone')?.invalid && newOwnerForm.get('phone')?.touched">
                @if (newOwnerForm.get('phone')?.invalid && newOwnerForm.get('phone')?.touched) {
                  <div class="error-message">El tel√©fono es obligatorio</div>
                }
              </div>

              <div class="form-group">
                <label>Direcci√≥n *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="address"
                  placeholder="Calle, n√∫mero"
                  [class.input-error]="newOwnerForm.get('address')?.invalid && newOwnerForm.get('address')?.touched">
                @if (newOwnerForm.get('address')?.invalid && newOwnerForm.get('address')?.touched) {
                  <div class="error-message">La direcci√≥n es obligatoria</div>
                }
              </div>

              <div class="form-group">
                <label>C√≥digo Postal *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="postal_code"
                  placeholder="28001"
                  maxlength="5"
                  [class.input-error]="newOwnerForm.get('postal_code')?.invalid && newOwnerForm.get('postal_code')?.touched">
                @if (newOwnerForm.get('postal_code')?.invalid && newOwnerForm.get('postal_code')?.touched) {
                  <div class="error-message">
                    @if (newOwnerForm.get('postal_code')?.errors?.['required']) {
                      <span>El c√≥digo postal es obligatorio</span>
                    }
                    @if (newOwnerForm.get('postal_code')?.errors?.['pattern']) {
                      <span>Debe tener 5 d√≠gitos</span>
                    }
                  </div>
                }
              </div>

              <div class="form-group">
                <label>Localidad *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="location"
                  placeholder="Madrid"
                  [class.input-error]="newOwnerForm.get('location')?.invalid && newOwnerForm.get('location')?.touched">
                @if (newOwnerForm.get('location')?.invalid && newOwnerForm.get('location')?.touched) {
                  <div class="error-message">La localidad es obligatoria</div>
                }
              </div>

              <div class="form-group">
                <label>Provincia *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="province"
                  placeholder="Madrid"
                  [class.input-error]="newOwnerForm.get('province')?.invalid && newOwnerForm.get('province')?.touched">
                @if (newOwnerForm.get('province')?.invalid && newOwnerForm.get('province')?.touched) {
                  <div class="error-message">La provincia es obligatoria</div>
                }
              </div>

              <div class="form-group">
                <label>Pa√≠s *</label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="country"
                  value="Espa√±a"
                  [class.input-error]="newOwnerForm.get('country')?.invalid && newOwnerForm.get('country')?.touched">
                @if (newOwnerForm.get('country')?.invalid && newOwnerForm.get('country')?.touched) {
                  <div class="error-message">El pa√≠s es obligatorio</div>
                }
              </div>
            </div>

            <div class="modal-actions">
              <button
                type="button"
                class="btn-secondary"
                (click)="cancelCreateOwner()">
                Cancelar
              </button>
              <button
                type="button"
                class="btn-success"
                (click)="saveNewOwner()"
                [disabled]="newOwnerForm.invalid">
                Guardar Propietario
              </button>
            </div>
          </div>
        </div>
      }
    </form>
  }





  <!-- === PASO 3: RESUMEN === -->
  @if (currentStep === 3) {
    <div class="summary-section">
      <h2>üìã Resumen Final</h2>
      <p class="step-description">Revisa la informaci√≥n antes de guardar definitivamente</p>

      <!-- === RESUMEN COMPLETO === -->
      <div class="summary-content">

        <!-- Informaci√≥n de la propiedad -->
        <div class="summary-section-item">
          <h3>üè† Propiedad Registrada</h3>
          @if (createdEstate) {
            <div class="property-summary">
              <div class="summary-row">
                <span class="label">Direcci√≥n:</span>
                <span class="value">{{ createdEstate.address }}</span>
              </div>
              <div class="summary-row">
                <span class="label">Referencia Catastral:</span>
                <span class="value ref-value">{{ createdEstate.cadastral_reference }}</span>
              </div>
              <div class="summary-row">
                <span class="label">Precio:</span>
                <span class="value price-value">{{ createdEstate.price }} ‚Ç¨</span>
              </div>
              <div class="summary-row">
                <span class="label">Superficie:</span>
                <span class="value">{{ createdEstate.surface }} m¬≤</span>
              </div>
              <div class="summary-row">
                <span class="label">Localidad:</span>
                <span class="value">{{ createdEstate.location }}, {{ createdEstate.province }}</span>
              </div>
            </div>
          }
        </div>

        <!-- Propietarios y porcentajes -->
        <div class="summary-section-item">
          <h3>üë• Propietarios Asignados</h3>
          <div class="owners-summary">
            @for (ownerControl of selectedOwnersArray.controls; track $index; let i = $index) {
              @if (ownerControl.get('owner')?.value) {
                <div class="owner-summary-row">
                  <div class="owner-info">
                    <strong>{{ ownerControl.get('owner')?.value.name }} {{ ownerControl.get('owner')?.value.lastname }}</strong>
                    <small>{{ ownerControl.get('owner')?.value.identification }}</small>
                  </div>
                  <div class="owner-percentage">
                    <span class="percentage-badge">{{ ownerControl.get('percentage')?.value }}%</span>
                  </div>
                </div>
              }
            }

            <!-- Total verificaci√≥n -->
            <div class="total-summary">
              <strong>Total: {{ getTotalPercentage() }}% ‚úÖ</strong>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="summary-section-item">
          <h3>‚ÑπÔ∏è Informaci√≥n</h3>
          <div class="info-summary">
            <ul>
              <li>‚úÖ La propiedad ya est√° guardada en el sistema</li>
              <li>üîÑ Los propietarios se guardar√°n al confirmar</li>
              <li>üìä Total de propietarios: {{ selectedOwnersArray.length }}</li>
              <li>üíæ Si alg√∫n propietario falla, podr√°s corregirlo despu√©s</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Botones finales -->
      <div class="actions-section">
        <button type="button" class="secondary-btn" (click)="currentStep = 2">
          ‚Üê Volver a Propietarios
        </button>
        <button type="button" class="primary-btn" (click)="saveAllOwnershipData()">
          üíæ Guardar Todo
        </button>
      </div>
    </div>
  }
</div>
