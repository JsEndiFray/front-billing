<!-- Formulario para editar porcentajes de propiedad inmueble-propietario -->
<div class="form-wrapper">
  <!-- T√≠tulo principal -->
  <h2>Editar Porcentaje de Propiedad</h2>

  <!-- Informaci√≥n actual - solo en modo edici√≥n -->
  @if (isEditMode && selectedEstate && selectedOwner) {
    <div class="current-info">
      <h3>üìã Datos Actuales</h3>

      <p><strong>üè¢ Inmueble:</strong> {{ selectedEstate.address }}</p>
      <p><strong>üë§ Propietario:</strong> {{ selectedOwner.name }} {{ selectedOwner.lastname }}</p>
      <p><strong>üìä Porcentaje:</strong> {{ originalPercentage }}%</p>

      <hr>
    </div>
  }

  <!-- Formulario principal -->
  <form (ngSubmit)="updateOwnership()" [formGroup]="estateOwnersFormGroup">

    <!-- Secci√≥n 1: Campos principales -->
    <div class="form-section">
      <h3>üè¢ Relaci√≥n Propietario-Inmueble</h3>

      <!-- Grid con los campos del formulario -->
      <div class="form-grid">

        <!-- Campo selector de inmueble -->
        <div class="form-field">
          <label for="estate_id">Inmueble *</label>
          <select
            formControlName="estate_id"
            name="estate_id"
            id="estate_id"
            class="form-select"
            (change)="findSelectedEstate()"
            required>
            <option value="">Seleccionar inmueble</option>
            <!-- Lista de inmuebles disponibles -->
            @if (estates && estates.length > 0) {
              @for (estate of estates; track estate.id) {
                <option [value]="estate.id">
                  {{ estate.address }} - {{ estate.cadastral_reference }}
                </option>
              }
            } @else {
              <option disabled>Cargando inmuebles...</option>
            }
          </select>

          <!-- Informaci√≥n del inmueble seleccionado -->
          @if (selectedEstate) {
            <div class="selected-info">
              <small>üìç Seleccionado: {{ selectedEstate.address }}</small>
            </div>
          }
        </div>

        <!-- Campo selector de propietario -->
        <div class="form-field">
          <label for="owners_id">Propietario *</label>
          <select
            formControlName="owners_id"
            name="owners_id"
            id="owners_id"
            class="form-select"
            (change)="findSelectedOwner()"
            required>
            <option value="">Seleccionar propietario</option>
            <!-- Lista de propietarios disponibles -->
            @if (owners && owners.length > 0) {
              @for (owner of owners; track owner.id) {
                <option [value]="owner.id">
                  {{ owner.name }} {{ owner.lastname }} ({{ owner.identification }})
                </option>
              }
            } @else {
              <option disabled>Cargando propietarios...</option>
            }
          </select>

          <!-- Informaci√≥n del propietario seleccionado -->
          @if (selectedOwner) {
            <div class="selected-info">
              <small>üë§ Seleccionado: {{ selectedOwner.name }} {{ selectedOwner.lastname }}</small>
            </div>
          }
        </div>

        <!-- Campo input de porcentaje -->
        <div class="form-field">
          <label for="ownership_percent">Porcentaje de Propiedad * (%)</label>
          <input
            type="number"
           formControlName="ownership_percentage"
            id="ownership_percent"
            class="form-input"
            placeholder="50.00"
            min="0.01"
            max="100"
            step="0.01"
            required>
          <small class="help-text">Ejemplo: 50.00 = 50%</small>

          <!-- Vista previa del porcentaje en tiempo real -->
          @if (estateOwnersFormGroup.get('ownership_percentage')?.value) {
            <div class="percentage-preview">
              <span class="percentage-value">{{ estateOwnersFormGroup.get('ownership_percentage')?.value}}%</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Secci√≥n 2: Resumen de cambios (solo en edici√≥n) -->
    @if (isEditMode && selectedEstate && selectedOwner) {
      <div class="edit-summary">
        <h3>üìù Resumen de Cambios</h3>
        <!-- Comparaci√≥n de valores anterior vs nuevo -->
        <div class="summary-grid">
          <div class="summary-item">
            <strong>Inmueble:</strong>
            <span>{{ selectedEstate.address }}</span>
          </div>
          <div class="summary-item">
            <strong>Propietario:</strong>
            <span>{{ selectedOwner.name }} {{ selectedOwner.lastname }}</span>
          </div>
          <div class="summary-item">
            <strong>Porcentaje Actual:</strong>
            <span class="old-value">{{ originalPercentage }}%</span>
          </div>
          <div class="summary-item">
            <strong>Nuevo Porcentaje:</strong>
            <span class="new-value">{{ estateOwnersFormGroup.get('ownership_percentage')?.value }}%</span>
          </div>
        </div>
      </div>
    }

    <!-- Secci√≥n 3: Informaci√≥n y validaciones -->
    <div class="info-section">
      <div class="info-card">
        <h4>‚ÑπÔ∏è Informaci√≥n Importante</h4>
        <!-- Reglas de validaci√≥n -->
        <ul>
          <li>El porcentaje debe estar entre 0.01% y 100%</li>
          <li>La suma de todos los porcentajes de un inmueble no debe exceder 100%</li>
          <li>Use decimales para porcentajes precisos (ej: 33.33 para un tercio)</li>
        </ul>

        <!-- Validaci√≥n del total de porcentajes -->
        @if (selectedEstate && totalPercentageForEstate > 0) {
          <div class="percentage-validation">
            <strong>Total actual para este inmueble: {{ totalPercentageForEstate }}%</strong>
            @if (totalPercentageForEstate > 100) {
              <span class="error">‚ö†Ô∏è Excede el 100%</span>
            } @else {
              <span class="success">‚úÖ V√°lido</span>
            }
          </div>
        }
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="button-group">
      <!-- Bot√≥n cancelar -->
      <button type="button" class="btn-secondary" (click)="goBack()">
        ‚Üê Cancelar
      </button>
      <!-- Bot√≥n enviar formulario -->
      <button
        type="submit"
        class="btn-primary"
        [disabled]="!estateOwnersFormGroup.valid || totalPercentageForEstate > 100">
        @if (isEditMode) {
          ‚úì Actualizar Porcentaje
        } @else {
          ‚úì Crear Relaci√≥n
        }
      </button>
    </div>

  </form>
</div>
