<!-- Formulario de creaci√≥n de facturas CON GESTI√ìN DE PAGOS -->
<div class="bills-register-wrapper">

  <!-- T√≠tulo del formulario -->
  <h2 class="bills-register-title">Crear Factura</h2>

  <!-- Formulario principal -->
  <form (ngSubmit)="registerBills()" class="bills-register-form">

    <!-- Secci√≥n: N√∫mero de factura -->

    <!-- Campo n√∫mero de factura autom√°tico -->
    <div class="bills-register-field bills-register-field-full">
      <label for="bills" class="bills-register-label">N√∫mero de Factura (autom√°tico)</label>
      <input
        type="text"
        disabled
        id="bills"
        class="bills-register-input bills-register-bill-number"
        placeholder="Se generar√° autom√°ticamente"
      />
    </div>

    <!-- Secci√≥n: Selecci√≥n de entidades -->

    <!-- Campo selector de propiedad -->
    <div class="bills-register-field">
      <label for="estate" class="bills-register-label">Propiedad *</label>
      <select
        required
        [(ngModel)]="bill.estates_id"
        name="estate_id"
        id="estate"
        class="bills-register-select">
        <option value="" disabled>Selecciona una propiedad</option>
        @for (estate of estates; track estate.id) {
          <option [value]="estate.id">
            {{ estate.address }} - {{ estate.cadastral_reference }}
          </option>
        }
      </select>
    </div>

    <!-- Campo selector de cliente -->
    <div class="bills-register-field">
      <label for="clients" class="bills-register-label">Cliente *</label>
      <select
        required
        [(ngModel)]="bill.clients_id"
        name="client_id"
        id="clients"
        class="bills-register-select">
        <option value="" disabled>Selecciona un cliente</option>
        @for (client of clients; track client.id) {
          <option [value]="client.id">
            {{ client.name }} {{ client.lastname }}
          </option>
        }
      </select>
    </div>

    <!-- Campo selector de propietario -->
    <div class="bills-register-field">
      <label for="owners" class="bills-register-label">Propietario *</label>
      <select
        required
        [(ngModel)]="bill.owners_id"
        name="owner_id"
        id="owners"
        class="bills-register-select">
        <option value="" disabled>Selecciona un propietario</option>
        @for (owner of owners; track owner.id) {
          <option [value]="owner.id">
            {{ owner.name }} {{ owner.lastname }}
          </option>
        }
      </select>
    </div>

    <!-- Campo de fecha -->
    <div class="bills-register-field">
      <label for="fecha" class="bills-register-label">Fecha *</label>
      <input
        type="date"
        [(ngModel)]="bill.date"
        name="date"
        id="fecha"
        class="bills-register-input bills-register-date"
        required
      />
    </div>

    <!-- Secci√≥n: C√°lculos financieros -->

    <!-- Campo base imponible -->
    <div class="bills-register-field">
      <label for="tax_base" class="bills-register-label">Base Imponible (‚Ç¨) *</label>
      <input
        type="number"
        [(ngModel)]="bill.tax_base"
        name="tax_base"
        id="tax_base"
        (input)="onTaxBaseChange()"
        step="0.01"
        min="0"
        placeholder="0.00"
        class="bills-register-input bills-register-currency"
        required
      />
    </div>

    <!-- Campo IVA -->
    <div class="bills-register-field">
      <label for="iva" class="bills-register-label">IVA (%)</label>
      <input
        type="number"
        [(ngModel)]="bill.iva"
        name="iva"
        id="iva"
        (input)="onIvaChange()"
        step="0.01"
        min="0"
        max="100"
        placeholder="21.00"
        class="bills-register-input bills-register-percentage"
      />
    </div>

    <!-- Campo IRPF -->
    <div class="bills-register-field">
      <label for="irpf" class="bills-register-label">IRPF (%)</label>
      <input
        type="number"
        [(ngModel)]="bill.irpf"
        name="irpf"
        id="irpf"
        (input)="onIrpfChange()"
        step="0.01"
        min="0"
        max="100"
        placeholder="15.00"
        class="bills-register-input bills-register-percentage"
      />
    </div>

    <!-- Campo total calculado -->
    <div class="bills-register-field">
      <label for="total" class="bills-register-label">Total (‚Ç¨)</label>
      <input
        type="number"
        [(ngModel)]="bill.total"
        name="total"
        id="total"
        readonly
        class="bills-register-input bills-register-total"
        placeholder="Calculado autom√°ticamente"
      />
    </div>

    <!--NUEVA SECCI√ìN: Informaci√≥n de Pago -->

    <!-- T√≠tulo de secci√≥n de pago -->
    <div class="bills-register-field bills-register-field-full">
      <h3 class="bills-register-section-title">üí≥ Informaci√≥n de Pago</h3>
    </div>

    <!-- Campo estado de pago -->
    <div class="bills-register-field">
      <label for="payment_status" class="bills-register-label">Estado de Pago</label>
      <select
        [(ngModel)]="bill.payment_status"
        name="payment_status"
        id="payment_status"
        (change)="onPaymentStatusChange()"
        class="bills-register-select bills-register-payment-status">
        <option value="pending">{{ paymentStatusLabels.pending }}</option>
        <option value="paid">{{ paymentStatusLabels.paid }}</option>
      </select>
    </div>

    <!-- Campo m√©todo de pago -->
    <div class="bills-register-field">
      <label for="payment_method" class="bills-register-label">M√©todo de Pago</label>
      <select
        [(ngModel)]="bill.payment_method"
        name="payment_method"
        id="payment_method"
        class="bills-register-select bills-register-payment-method">
        <option value="transfer">{{ paymentMethodLabels.transfer }}</option>
        <option value="direct_debit">{{ paymentMethodLabels.direct_debit }}</option>
        <option value="cash">{{ paymentMethodLabels.cash }}</option>
        <option value="card">{{ paymentMethodLabels.card }}</option>
      </select>
    </div>

    <!-- Campo fecha de pago (solo si est√° marcado como pagado) -->
    <div class="bills-register-field">
      <label for="payment_date" class="bills-register-label">
        Fecha de Pago
        @if (bill.payment_status === 'paid') {
          <span class="bills-register-required">*</span>
        }
      </label>
      <input
        type="date"
        [(ngModel)]="bill.payment_date"
        name="payment_date"
        id="payment_date"
        class="bills-register-input bills-register-payment-date"
        [required]="bill.payment_status === 'paid'"
        [disabled]="bill.payment_status === 'pending'"
        placeholder="Fecha en que se realiz√≥ el pago"
      />
      @if (bill.payment_status === 'pending') {
        <small class="bills-register-help-text">
          Se habilitar√° al marcar como "Pagado"
        </small>
      }
    </div>

    <!-- Campo notas de pago -->
    <div class="bills-register-field">
      <label for="payment_notes" class="bills-register-label">Notas del Pago (opcional)</label>
      <textarea
        [(ngModel)]="bill.payment_notes"
        name="payment_notes"
        id="payment_notes"
        rows="3"
        class="bills-register-textarea bills-register-payment-notes"
        placeholder="Ej: N√∫mero de transferencia, referencia del pago, observaciones..."
      ></textarea>
    </div>

    <!-- ‚úÖ INFORMACI√ìN VISUAL DEL ESTADO -->
    <div class="bills-register-field bills-register-field-full">
      <div class="bills-register-payment-summary">
        <div class="payment-summary-item">
          <span class="payment-summary-label">Estado:</span>
          <span class="payment-summary-value"
                [class.status-pending]="bill.payment_status === 'pending'"
                [class.status-paid]="bill.payment_status === 'paid'">
            {{ paymentStatusLabels[bill.payment_status || 'pending'] }}
          </span>
        </div>
        <div class="payment-summary-item">
          <span class="payment-summary-label">M√©todo:</span>
          <span class="payment-summary-value">
            {{ paymentMethodLabels[bill.payment_method || 'transfer'] }}
          </span>
        </div>
        @if (bill.payment_date) {
          <div class="payment-summary-item">
            <span class="payment-summary-label">Fecha de Pago:</span>
            <span class="payment-summary-value">{{ bill.payment_date }}</span>
          </div>
        }
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="bills-register-buttons">
      <button type="submit" class="bills-register-btn-primary">
        üí∞ Crear Factura
      </button>
      <button type="button" class="bills-register-btn-secondary" (click)="goBack()">
        ‚Üê Cancelar
      </button>
    </div>

  </form>
</div>
