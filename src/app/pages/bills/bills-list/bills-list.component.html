<div class="list-wrapper">
  <h2>Listado de Facturas</h2>

  <!-- Barra de búsqueda -->
  <div class="search-container">
    <!-- Campo de búsqueda con filtro en tiempo real -->
    <div class="search-wrapper">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Buscar por número de factura, cliente, propietario..."
        class="search-input"
      >
      <!-- Iconos de búsqueda y limpiar -->
      <div class="search-actions">
        <span class="search-icon">🔍</span>
        @if (searchTerm && searchTerm.trim() !== '') {
          <button
            type="button"
            (click)="clearSearch()"
            class="clear-button"
            title="Limpiar búsqueda"
          >
            ✕
          </button>
        }
      </div>
    </div>
    <!-- Contador de resultados de búsqueda -->
    @if (searchTerm && searchTerm.trim() !== '') {
      <div class="search-results-info">
        <span>Mostrando {{ bills.length }} de {{ allBills.length }} Facturas</span>
      </div>
    }
  </div>
  <!-- Botón principal con nueva clase -->
  <button class="btn-new-bill" (click)="createNewBill()" type="button">
    + Nueva Factura
  </button>


  <!-- Tabla de facturas -->
  <table>
    <!-- Encabezados de la tabla -->
    <thead>
    <tr>
      <th>ID</th>
      <th>Nº Factura</th>
      <th>Propiedad</th>
      <th>Cliente</th>
      <th>Propietario</th>
      <th>%</th>
      <th>Fecha de factura</th>
      <th>Base Imponible</th>
      <th>Iva</th>
      <th>Irpf</th>
      <th>Total</th>
      <th>Abonos</th>
      <th>F. Abonada</th>
      <th>Creado</th>
      <th>Actualizado</th>
      <th>Acciones</th>
    </tr>
    </thead>

    <!-- Contenido de la tabla -->
    <tbody>
      @if (bills && bills.length > 0) {
        @for (bill of bills; track bill.id) {
          <tr>
            <td>{{ bill.id }}</td>
            <td>{{ bill.bill_number }}</td>
            <td>{{ bill.estates_id }}</td>
            <td>{{ bill.clients_id }}</td>
            <td>{{ bill.owners_id }}</td>
            <td>{{ bill.ownership_percent }}%</td>
            <td>{{ bill.date | dataFormat }}</td>
            <td>{{ bill.tax_base }} €</td>
            <td>{{ bill.iva }}%</td>
            <td>{{ bill.irpf }}%</td>
            <td>{{ bill.total }} €</td>


            <!-- DEVOLUCIÓN: 1 = Sí, 0 = No -->
            <td>
    <span [ngClass]="bill.is_refund ===1 ? 'refund-badge' : 'no-refund'">
      {{ bill.is_refund === 1 ? 'Sí' : 'No' }}
    </span>
            </td>

            <!-- FACTURA ORIGINAL: NULL = '-', número = mostrar ID -->
            <td>{{ bill.original_bill_number || '-' }}</td>


            <td>{{ bill.date_create | dataFormat }}</td>
            <td>{{ bill.date_update | dataFormat }}</td>

            <!-- Botones de acción por propiedad -->
            <td>

              <button (click)="editBill(bill.id!)">Editar</button>
              <button (click)="downloadPDF(bill.id!)">📄 PDF</button>

              <button (click)="deleteBill(bill.id!)">Eliminar</button>


            </td>
          </tr>
        }

      } @else {
        <!--MENSAJE CUANDO NO HAY FACTURAS-->
        <tr>
          <td colspan="16" class="no-bills-cell">
            <div class="no-bills-card">
              <!-- Icono visual para mejor UX -->
              <div class="no-bills-icon">
                📄
              </div>
              <h3>Sin Facturas</h3>
              <p>No hay facturas disponibles en este momento.</p>
              <!-- Botón opcional para crear nueva factura -->
              <button
                class="btn-create-bill" (click)="createNewBill()" type="button"> + Nueva Factura
              </button>
            </div>
          </td>
        </tr>

      }

    </tbody>
  </table>
</div>
