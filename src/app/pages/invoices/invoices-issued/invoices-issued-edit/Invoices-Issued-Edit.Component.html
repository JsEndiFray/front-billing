<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Editar Factura</h1>
    <p class="subtitle">Modificar informaci√≥n de la factura existente</p>
  </div>

  <!-- Formulario principal con FormGroup -->
  <form [formGroup]="invoiceForm" (ngSubmit)="updateInvoice()">

    <!-- Secci√≥n: Informaci√≥n B√°sica -->
    <div class="section">
      <h2 class="section-title">üìÑ Informaci√≥n B√°sica</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="invoice_number" class="form-label">N√∫mero de Factura *</label>
          <input
            type="text"
            formControlName="invoice_number"
            id="invoice_number"
            placeholder="FAC-2025-0001"
            class="form-input invoice-number-input">
        </div>

        <div class="form-field">
          <label for="invoice_date" class="form-label">Fecha de Emisi√≥n *</label>
          <input
            type="date"
            formControlName="invoice_date"
            id="invoice_date"
            class="form-input">
          @if (isFieldInvalid('invoice_date')) {
            <small class="error-text">La fecha es requerida</small>
          }
        </div>

        <div class="form-field">
          <label for="is_refund" class="form-label">Tipo de Factura</label>
          <select
            formControlName="is_refund"
            id="is_refund"
            class="form-input">
            @for (type of billingTypeLabels; track type.value){
              <option [value]="type.value">{{type.label}}</option>
            }
          </select>
        </div>

        @if (invoiceForm.get('is_refund')?.value === 1) {
          <div class="form-field">
            <label for="original_invoice_id" class="form-label">Factura Original</label>
            <select
              formControlName="original_invoice_id"
              id="original_invoice_id"
              class="form-input">
              <option value="">Seleccionar factura original</option>
              @for (originalInvoice of originalInvoices; track originalInvoice.id) {
                <option [value]="originalInvoice.id">
                  {{ originalInvoice.invoice_number }} - {{ originalInvoice.invoice_date | dataFormat }}
                </option>
              }
            </select>
          </div>
        }

      </div>
    </div>

    <!-- Secci√≥n: Relaciones -->
    <div class="section">
      <h2 class="section-title">üîó Relaciones</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="estates_id" class="form-label">Inmueble *</label>
          <select
            formControlName="estates_id"
            id="estates_id"
            class="form-input">
            <option value="">Seleccionar inmueble</option>
            @for (estate of estates; track estate.id) {
              <option [value]="estate.id">
                {{ estate.address }} - {{ estate.cadastral_reference }}
              </option>
            }
          </select>
          @if (isFieldInvalid('estates_id')) {
            <small class="error-text">Seleccione un inmueble</small>
          }
        </div>

        <div class="form-field">
          <label for="clients_id" class="form-label">Cliente *</label>
          <select
            formControlName="clients_id"
            id="clients_id"
            class="form-input">
            <option value="">Seleccionar cliente</option>
            @for (client of clients; track client.id) {
              <option [value]="client.id">
                {{ client.name }} {{ client.lastname }} ({{ client.identification }})
              </option>
            }
          </select>
          @if (isFieldInvalid('clients_id')) {
            <small class="error-text">Seleccione un cliente</small>
          }
        </div>

        <div class="form-field">
          <label for="owners_id" class="form-label">Propietario *</label>
          <select
            formControlName="owners_id"
            id="owners_id"
            class="form-input">
            <option value="">Seleccionar propietario</option>
            @for (owner of owners; track owner.id) {
              <option [value]="owner.id">
                {{ owner.name }} {{ owner.lastname }} ({{ owner.identification }})
              </option>
            }
          </select>
          @if (isFieldInvalid('owners_id')) {
            <small class="error-text">Seleccione un propietario</small>
          }
        </div>

        <div class="form-field">
          <label for="ownership_percent" class="form-label">Porcentaje de Propiedad (%)</label>
          <input
            type="number"
            formControlName="ownership_percent"
            id="ownership_percent"
            placeholder="50.00"
            min="0.01"
            max="100"
            step="0.01"
            class="form-input percentage-input">
        </div>

      </div>
    </div>

    <!-- Secci√≥n: Informaci√≥n Financiera -->
    <div class="section">
      <h2 class="section-title">üí∞ Informaci√≥n Financiera</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="tax_base" class="form-label">Base Imponible (‚Ç¨) *</label>
          <input
            type="number"
            formControlName="tax_base"
            id="tax_base"
            placeholder="1000.00"
            min="0"
            step="0.01"
            (input)="calculateTotal()"
            class="form-input currency-input">
          @if (isFieldInvalid('tax_base')) {
            <small class="error-text">Base imponible m√≠nima: 0.01‚Ç¨</small>
          }
        </div>

        <div class="form-field">
          <label for="iva" class="form-label">IVA (%)</label>
          <input
            type="number"
            formControlName="iva"
            id="iva"
            placeholder="21"
            min="0"
            max="100"
            step="0.01"
            (input)="calculateTotal()"
            class="form-input currency-input">
        </div>

        <div class="form-field">
          <label for="irpf" class="form-label">IRPF (%)</label>
          <input
            type="number"
            formControlName="irpf"
            id="irpf"
            placeholder="15"
            min="0"
            max="100"
            step="0.01"
            (input)="calculateTotal()"
            class="form-input currency-input">
        </div>

        <div class="form-field">
          <label for="total" class="form-label">Total Final (‚Ç¨)</label>
          <input
            type="number"
            formControlName="total"
            id="total"
            readonly
            class="form-input total-input">
          <small class="help-text">Calculado autom√°ticamente: Base + IVA - IRPF</small>
        </div>

      </div>
    </div>

    <!-- Secci√≥n: Tipo de Facturaci√≥n -->
    <div class="section">
      <h2 class="section-title">üìä Tipo de Facturaci√≥n</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="is_proportional" class="form-label">Tipo de Facturaci√≥n</label>
          <select
            formControlName="is_proportional"
            id="is_proportional"
            (change)="onBillingTypeChange()"
            class="form-input billing-type-select">
            @for (type of billingTypeLabels; track type.value) {
              <option [value]="type.value">{{ type.label }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="corresponding_month" class="form-label">Mes de Correspondencia</label>
          <input
            type="month"
            formControlName="corresponding_month"
            id="corresponding_month"
            class="form-input month-input">
          <small class="help-text">Opcional: Para indicar a qu√© mes corresponde</small>
        </div>

        @if (invoiceForm.get('is_proportional')?.value === 1) {
          <div class="form-field">
            <label for="start_date" class="form-label">Fecha de Inicio *</label>
            <input
              type="date"
              formControlName="start_date"
              id="start_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input">
          </div>

          <div class="form-field">
            <label for="end_date" class="form-label">Fecha de Fin *</label>
            <input
              type="date"
              formControlName="end_date"
              id="end_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input">
          </div>
        }

      </div>

      <!-- Simulaci√≥n proporcional -->
      @if (simulationResult) {
        <div class="proportional-summary">
          <h4>üßÆ C√°lculo Proporcional</h4>
          <div class="proportional-details">
            <div class="detail-item">
              <span class="detail-label">Per√≠odo:</span>
              <span class="detail-value">{{ simulationResult.periodDescription }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">D√≠as facturados:</span>
              <span class="detail-value">{{ simulationResult.details.days_billed }} de {{ simulationResult.details.days_in_month }}</span>
            </div>
            <div class="detail-item total-line">
              <span class="detail-label">Total proporcional:</span>
              <span class="detail-value">{{ simulationResult.total | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Secci√≥n: Informaci√≥n de Cobro -->
    <div class="section">
      <h2 class="section-title">üí≥ Informaci√≥n de Cobro</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="collection_status" class="form-label">Estado de Cobro *</label>
          <select
            formControlName="collection_status"
            id="collection_status"
            (change)="onCollectionStatusChange()"
            class="form-input">
            @for (status of collectionStatusLabels; track status.value) {
              <option [value]="status.value">{{ status.label }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="collection_method" class="form-label">M√©todo de Cobro *</label>
          <select
            formControlName="collection_method"
            id="collection_method"
            class="form-input">
            @for (method of collectionMethodLabels; track method.value) {
              <option [value]="method.value">{{ method.label }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="collection_date" class="form-label">Fecha de Cobro</label>
          <input
            type="date"
            formControlName="collection_date"
            id="collection_date"
            class="form-input">
        </div>

        <div class="form-field">
          <label for="collection_reference" class="form-label">Referencia</label>
          <input
            type="text"
            formControlName="collection_reference"
            id="collection_reference"
            placeholder="Referencia de transferencia"
            class="form-input">
        </div>

      </div>
    </div>

    <!-- Botones -->
    <div class="actions-section">
      <button type="submit" [disabled]="!invoiceForm.valid" class="primary-btn">
        ‚úì Actualizar Factura
      </button>
      <button type="button" class="secondary-btn" (click)="goBack()">
        ‚Üê Cancelar
      </button>
    </div>

  </form>
</div>
