<div class="container">
  <!-- Título y descripción -->
  <div class="header">
    <h1 class="title">Editar Factura</h1>
    <p class="subtitle">Modificar información de la factura existente</p>
  </div>

  <!-- Formulario principal -->
  <form (ngSubmit)="updateInvoice()">

    <!-- Sección: Información Básica -->
    <div class="section">
      <h2 class="section-title">📄 Información Básica</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="bill_number" class="form-label">Número de Factura *</label>
          <input
            type="text"
            [(ngModel)]="invoice.invoice_number"
            name="bill_number"
            id="bill_number"
            placeholder="FAC-2025-0001"
            class="form-input invoice-number-input"
            required>
        </div>

        <div class="form-field">
          <label for="date" class="form-label">Fecha de Emisión *</label>
          <input
            type="date"
            [(ngModel)]="invoice.invoice_date"
            name="date"
            id="date"
            class="form-input"
            required>
        </div>

        <div class="form-field">
          <label for="is_refund" class="form-label">Tipo de Factura</label>
          <select
            [(ngModel)]="invoice.is_refund"
            name="is_refund"
            id="is_refund"
            class="form-input">
            <option [value]="0">Factura Normal</option>
            <option [value]="1">Factura de Devolución</option>
          </select>
        </div>

        @if (invoice.is_refund === 1) {
          <div class="form-field">
            <label for="original_bill_id" class="form-label">Factura Original</label>
            <select
              [(ngModel)]="invoice.original_invoice_id"
              name="original_bill_id"
              id="original_bill_id"
              class="form-input">
              <option value="">Seleccionar factura original</option>
              @if (originalInvoices && originalInvoices.length > 0) {
                @for (originalInvoice of originalInvoices; track originalInvoice.id) {
                  <option [value]="originalInvoice.id">
                    {{ originalInvoice.invoice_number }} - {{ originalInvoice.invoice_date | dataFormat }}
                  </option>
                }
              }
            </select>
          </div>
        }

      </div>
    </div>

    <!-- Sección: Relaciones -->
    <div class="section">
      <h2 class="section-title">🔗 Relaciones</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="estate_id" class="form-label">Inmueble *</label>
          <select
            [(ngModel)]="invoice.estates_id"
            name="estate_id"
            id="estate_id"
            class="form-input"
            required>
            <option value="">Seleccionar inmueble</option>
            @if (estates && estates.length > 0) {
              @for (estate of estates; track estate.id) {
                <option [value]="estate.id">
                  {{ estate.address }} - {{ estate.cadastral_reference }}
                </option>
              }
            }
          </select>
        </div>

        <div class="form-field">
          <label for="clients_id" class="form-label">Cliente *</label>
          <select
            [(ngModel)]="invoice.clients_id"
            name="clients_id"
            id="clients_id"
            class="form-input"
            required>
            <option value="">Seleccionar cliente</option>
            @if (clients && clients.length > 0) {
              @for (client of clients; track client.id) {
                <option [value]="client.id">
                  {{ client.name }} {{ client.lastname }} ({{ client.identification }})
                </option>
              }
            }
          </select>
        </div>

        <div class="form-field">
          <label for="owners_id" class="form-label">Propietario *</label>
          <select
            [(ngModel)]="invoice.owners_id"
            name="owners_id"
            id="owners_id"
            class="form-input"
            required>
            <option value="">Seleccionar propietario</option>
            @if (owners && owners.length > 0) {
              @for (owner of owners; track owner.id) {
                <option [value]="owner.id">
                  {{ owner.name }} {{ owner.lastname }} ({{ owner.identification }})
                </option>
              }
            }
          </select>
        </div>

        <div class="form-field">
          <label for="ownership_percent" class="form-label">Porcentaje de Propiedad (%)</label>
          <input
            type="number"
            [(ngModel)]="invoice.ownership_percent"
            name="ownership_percent"
            id="ownership_percent"
            placeholder="50.00"
            min="0.01"
            max="100"
            step="0.01"
            class="form-input percentage-input">
        </div>

      </div>
    </div>

    <!-- Sección: Información Financiera -->
    <div class="section">
      <h2 class="section-title">💰 Información Financiera</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="tax_base" class="form-label">Base Imponible (€) *</label>
          <input
            type="number"
            [(ngModel)]="invoice.tax_base"
            name="tax_base"
            id="tax_base"
            placeholder="1000.00"
            min="0"
            step="0.01"
            (ngModelChange)="calculateTotal()"
            class="form-input currency-input"
            required>
        </div>

        <div class="form-field">
          <label for="iva" class="form-label">IVA (€)</label>
          <input
            type="number"
            [(ngModel)]="invoice.iva"
            name="iva"
            id="iva"
            placeholder="210.00"
            min="0"
            step="0.01"
            (ngModelChange)="calculateTotal()"
            class="form-input currency-input">
        </div>

        <div class="form-field">
          <label for="irpf" class="form-label">IRPF (€)</label>
          <input
            type="number"
            [(ngModel)]="invoice.irpf"
            name="irpf"
            id="irpf"
            placeholder="150.00"
            min="0"
            step="0.01"
            (ngModelChange)="calculateTotal()"
            class="form-input currency-input">
        </div>

        <div class="form-field">
          <label for="total" class="form-label">Total Final (€) *</label>
          <input
            type="number"
            [(ngModel)]="invoice.total"
            name="total"
            id="total"
            placeholder="1060.00"
            min="0"
            step="0.01"
            readonly
            class="form-input total-input">
          <small class="help-text">Calculado automáticamente: Base + IVA - IRPF</small>
        </div>

      </div>
    </div>

    <!-- Sección: Tipo de Facturación -->
    <div class="section">
      <h2 class="section-title">📊 Tipo de Facturación</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="is_proportional" class="form-label">Tipo de Facturación</label>
          <select
            [(ngModel)]="invoice.is_proportional"
            name="is_proportional"
            id="is_proportional"
            (change)="onBillingTypeChange()"
            class="form-input billing-type-select">
            <option value="0">{{ billingTypeLabels[0] }}</option>
            <option value="1">{{ billingTypeLabels[1] }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="corresponding_month" class="form-label">Mes de Correspondencia</label>
          <input
            type="month"
            [(ngModel)]="invoice.corresponding_month"
            name="corresponding_month"
            id="corresponding_month"
            placeholder="Ej: 2025-06 para Junio 2025"
            class="form-input month-input">
          <small class="help-text">Opcional: Para indicar a qué mes corresponde esta factura</small>
        </div>

        <!-- Campos proporcionales (solo si está seleccionado) -->
        @if (invoice.is_proportional == 1) {
          <div class="form-field">
            <label for="start_date" class="form-label">
              Fecha de Inicio *
              <span class="required-indicator">*</span>
            </label>
            <input
              type="date"
              [(ngModel)]="invoice.start_date"
              name="start_date"
              id="start_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input"
              required>
          </div>

          <div class="form-field">
            <label for="end_date" class="form-label">
              Fecha de Fin *
              <span class="required-indicator">*</span>
            </label>
            <input
              type="date"
              [(ngModel)]="invoice.end_date"
              name="end_date"
              id="end_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input"
              required>
          </div>
        }

      </div>

      <!-- Información de simulación proporcional -->
      @if (simulationResult) {
        <div class="proportional-summary">
          <h4>🧮 Cálculo Proporcional</h4>
          <div class="proportional-details">
            <div class="detail-item">
              <span class="detail-label">Período:</span>
              <span class="detail-value">{{ simulationResult.periodDescription }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Días facturados:</span>
              <span class="detail-value">{{ simulationResult.details.days_billed }}
                de {{ simulationResult.details.days_in_month }} días</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Porcentaje:</span>
              <span class="detail-value">{{ simulationResult.details.proportion_percentage }}%</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Base original:</span>
              <span class="detail-value">{{ simulationResult.details.original_base | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Base proporcional:</span>
              <span class="detail-value">{{ simulationResult.details.proportional_base | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="detail-item total-line">
              <span class="detail-label">Total proporcional:</span>
              <span class="detail-value">{{ simulationResult.total | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      }

      <!-- Estado de carga durante simulación -->
      @if (isSimulating) {
        <div class="loading-state">
          <span>🔄 Calculando facturación proporcional...</span>
        </div>
      }
    </div>

    <!-- Sección: Información de Pago -->
    <div class="section">
      <h2 class="section-title">💳 Información de Pago</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="payment_status" class="form-label">Estado de Pago *</label>
          <select
            [(ngModel)]="invoice.collection_status"
            name="payment_status"
            id="payment_status"
            (change)="onCollectionStatusChange()"
            class="form-input payment-status-select"
            required>
            <option value="pending">{{ collectionStatusLabels.pending }}</option>
            <option value="paid">{{ collectionStatusLabels.collected }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="payment_method" class="form-label">Método de Pago *</label>
          <select
            [(ngModel)]="invoice.collection_method"
            name="payment_method"
            id="payment_method"
            class="form-input collection-method-select"
            required>
            <option value="transfer">{{ collectionMethodLabels.transfer }}</option>
            <option value="direct_debit">{{ collectionMethodLabels.direct_debit }}</option>
            <option value="cash">{{ collectionMethodLabels.cash }}</option>
            <option value="card">{{ collectionMethodLabels.card }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="payment_date" class="form-label">
            Fecha de Pago
            @if (invoice.collection_status === 'collected') {
              <span class="required-indicator">*</span>
            }
          </label>
          <input
            type="date"
            [(ngModel)]="invoice.collection_date"
            name="payment_date"
            id="payment_date"
            [required]="invoice.collection_status === 'collected'"
            [disabled]="invoice.collection_status === 'pending'"
            class="form-input collection-date-input">
          @if (invoice.collection_status === 'pending') {
            <small class="help-text">
              Se habilitará al marcar como "Pagado"
            </small>
          }
        </div>

        <div class="form-field form-field-full">
          <label for="payment_notes" class="form-label">Notas del Pago</label>
          <textarea
            [(ngModel)]="invoice.collection_notes"
            name="payment_notes"
            id="payment_notes"
            rows="3"
            placeholder="Ej: Número de transferencia, referencia del pago, observaciones..."
            class="form-input collection-notes-textarea">
          </textarea>
        </div>

      </div>

      <!-- Información visual del estado -->
      <div class="collection-summary">
        <div class="collection-summary-item">
          <span class="collection-summary-label">Estado:</span>
          <span class="collection-summary-value"
                [class.status-pending]="invoice.collection_status === 'pending'"
                [class.status-paid]="invoice.collection_status === 'collected'">
            {{ collectionStatusLabels[invoice.collection_status || 'pending'] }}
          </span>
        </div>
        <div class="collection-summary-item">
          <span class="collection-summary-label">Método:</span>
          <span class="collection-summary-value">
            {{ collectionMethodLabels[invoice.collection_method || 'transfer'] }}
          </span>
        </div>
        @if (invoice.collection_date) {
          <div class="collection-summary-item">
            <span class="collection-summary-label">Fecha de Pago:</span>
            <span class="collection-summary-value">{{ invoice.collection_date }}</span>
          </div>
        }
        @if (invoice.collection_notes) {
          <div class="collection-summary-item">
            <span class="collection-summary-label">Notas:</span>
            <span class="collection-summary-value">{{ invoice.collection_notes }}</span>
          </div>
        }
      </div>
    </div>

    <!-- Sección: Información de Cálculo -->
    <div class="section">
      <h2 class="section-title">🧮 Resumen de Cálculo</h2>
      <div class="calculation-summary">
        <div class="calc-item">
          <span class="calc-label">Base Imponible:</span>
          <span class="calc-value">{{ invoice.tax_base || 0 | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">+ IVA:</span>
          <span class="calc-value">{{ invoice.iva || 0 | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
        <div class="calc-item">
          <span class="calc-label">- IRPF:</span>
          <span class="calc-value">{{ invoice.irpf || 0 | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
        <div class="calc-item total-line">
          <span class="calc-label">= Total:</span>
          <span class="calc-value">{{ invoice.total || 0 | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="actions-section">
      <button type="submit" class="primary-btn">
        ✓ Actualizar Factura
      </button>
      <button type="button" class="secondary-btn" (click)="goBack()">
        ← Cancelar
      </button>
    </div>

  </form>
</div>
