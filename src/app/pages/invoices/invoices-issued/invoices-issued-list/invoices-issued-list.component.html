<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Gesti√≥n de Facturas</h1>
    <p class="subtitle">Administra el listado completo de facturas emitidas</p>
  </div>

  <!-- Secci√≥n de filtros y b√∫squeda -->
  <div class="filters-section">
    <form class="search-container" [formGroup]="searchForm">
      <div class="search-wrapper">
        <input type="text" formControlName="searchTerm"
               placeholder="Buscar por n√∫mero de factura, cliente, propietario..."
               class="search-input"
               autocomplete="off">
        <div class="search-actions">
          <span class="search-icon">üîç</span>
          @if (searchForm.get('searchTerm')?.value) {
            <button type="button" (click)="clearFilters()" class="clear-button" title="Limpiar b√∫squeda">‚úï</button>
          }
        </div>
      </div>
    </form>
  </div>

  <!-- Todos los filtros-->
  <div class="filters-container">

    <!-- Filtro estado de facturas-->
    <form [formGroup]="filtersForm">


      <!-- Nuevos filtros de fecha -->
      <div class="date-filters">
        <input type="date" formControlName="startDate" class="filter-input" placeholder="Fecha desde">
        <input type="date" formControlName="endDate" class="filter-input" placeholder="Fecha hasta">
      </div>

      <!-- Nuevos filtros de monto -->
      <div class="amount-filters">
        <input type="number" formControlName="minAmount" class="filter-input" placeholder="Monto m√≠nimo" min="0"
               step="0.01">
        <input type="number" formControlName="maxAmount" class="filter-input" placeholder="Monto m√°ximo" min="0"
               step="0.01">
      </div>

      <!-- Mostrar errores de validaci√≥n -->
      @if (filtersForm.hasError('dateRange')) {
        <div class="filter-error">{{ filtersForm.getError('dateRange').message }}</div>
      }
      @if (filtersForm.hasError('amountRange')) {
        <div class="filter-error">{{ filtersForm.getError('amountRange').message }}</div>
      }



      <select formControlName="selectedCollectionStatus" class="filter-select">
        <option value="">Estado de Cobro</option>
        @for (status of collectionStatusLabels; track status.value) {
          <option [value]="status.value">{{ status.label }}</option>
        }
      </select>

      <!-- Filtro de facturas por mes o proporcional-->
      <select formControlName="selectedTypeBilling" class="filter-select">
        <option value="">Por Facturaci√≥n</option>
        @for (typesBill of billingTypeLabels; track typesBill.value) {
          <option [value]="typesBill.value">{{ typesBill.label }}</option>
        }
      </select>

      <!-- Filtro por propietarios-->
      <select formControlName="selectedOwners" class="filter-select">
        <option value="">Por Propietarios</option>
        @for (owner of ownersOptions; track owner) {
          <option [value]="owner">{{ owner }}</option>
        }
      </select>

      <!-- Filtro por cliente-->
      <select formControlName="selectedClients" class="filter-select">
        <option value="">Por Cliente</option>
        @for (client of clientsOptions; track client) {
          <option [value]="client">{{ client }}</option>
        }
      </select>

      <!-- Filtro de facturas de abono-->
      <select formControlName="selectedRefundStatus" class="filter-select">
        <option value="">Por Tipo</option>
        @for (refunds of refundStatusOptions; track refunds.value) {
          <option [value]="refunds.value">{{ refunds.label }}</option>

        }
      </select>

      <!-- Bot√≥n limpiar filtros -->
      <button
        type="button"
        (click)="clearFilters()"
        class="clear-filters-btn"
        title="Limpiar todos los filtros">
        Limpiar filtros
      </button>

    </form>
    <!-- Bot√≥n nueva factura emitida -->
    <div class="actions-container">
      <button class="export-btn">Exportar</button>
      <button class="new-invoice-btn" (click)="createNewInvoice()">+ Nueva Factura</button>
    </div>
  </div>

  <!-- Configuraci√≥n de paginaci√≥n -->
  <div class="pagination-config">
    <form [formGroup]="paginationForm">
      <label for="itemsPerPage">Elementos por p√°gina:</label>
      <select
        id="itemsPerPage"
        formControlName="itemsPerPage"
        class="items-per-page-select">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
    </form>
  </div>


  <!-- Tabla de facturas -->
  <div class="table-container">
    <table class="invoices-table">

      <!-- Cabecera -->
      <thead>
      <tr>
        <th>ID</th>
        <th>N¬∫ FACTURA</th>
        <th>PROPIEDAD</th>
        <th>CLIENTE</th>
        <th>PROPIETARIO</th>
        <th>FECHA</th>
        <th>BASE</th>
        <th>IVA</th>
        <th>IRPF</th>
        <th>TOTAL</th>
        <th>TIPO FACTURACI√ìN</th>
        <th>PER√çODO</th>
        <th>MES CORRESPONDIENTE</th>
        <th>ESTADO PAGO</th>
        <th>M√âTODO PAGO</th>
        <th>FECHA PAGO</th>
        <th>ABONOS</th>
        <th>FACTURA DE ABONADA</th>
        <th>ACCIONES</th>
      </tr>
      </thead>

      <!-- Cuerpo de la tabla -->
      <tbody>
        @if (invoices && invoices.length > 0) {
          @for (invoice of invoices; track invoice.id) {
            <tr>
              <td>#{{ invoice.id }}</td>
              <td class="invoice-number-cell">{{ invoice.invoice_number }}</td>
              <td title="ID: {{ invoice.estates_id }}">{{ invoice.estate_name }}</td>
              <td class="client-cell" title="ID: {{invoice.clients_id}}">{{ invoice.client_name }}</td>
              <td class="owner-cell" title="ID: {{invoice.owners_id}}">{{ invoice.owner_name }}</td>
              <td>{{ invoice.invoice_date | dataFormat }}</td>
              <td class="currency-cell">{{ invoice.tax_base | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td class="tax-cell">{{ invoice.iva }}%</td>
              <td class="tax-cell">{{ invoice.irpf }}%</td>
              <td class="total-cell">{{ invoice.total | currency:'EUR':'symbol':'1.2-2' }}</td>

              <!-- TIPO DE FACTURACI√ìN -->
              <td>
                <span
                  [ngClass]="invoicesUtilService.isInvoiceProportional(invoice) ? 'proportional-badge' : 'normal-badge'">
                  @if (invoicesUtilService.isInvoiceProportional(invoice)) {
                    üìä {{ billingTypeLabels[1].label }}
                  } @else {
                    üìÑ {{ billingTypeLabels[0].label }}
                  }
                </span>
              </td>

              <!-- PER√çODO -->
              <td>
                @if (invoicesUtilService.isInvoiceProportional(invoice)) {
                  <span class="proportional-period" [title]="invoicesUtilService.getProportionalDays(invoice)">
                    {{ invoicesUtilService.getProportionalPeriod(invoice) }}
                  </span>
                } @else {
                  <span class="normal-period">Mes completo</span>
                }
              </td>

              <!-- MES CORRESPONDENCIA -->
              <td>
                <span class="corresponding-month">
                  {{ invoicesUtilService.getCorrespondingMonthDisplay(invoice) }}
                </span>
              </td>

              <!-- ESTADO DE PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <div class="collection-status-container">
                    <span
                      [ngClass]="invoice.collection_status === 'collected' ? 'paid-badge' : 'pending-badge'"
                      (click)="toggleCollectionStatus(invoice)"
                      title="Clic para cambiar estado">
                      {{ invoicesUtilService.getStatusLabel(invoice.collection_status || 'pending') }}
                    </span>
                    <button
                      class="edit-payment-btn"
                      (click)="startEditingCollection(invoice)"
                      title="Editar detalles">
                      ‚úèÔ∏è
                    </button>
                  </div>
                } @else {
                  @if (getCollectionFormGroup(invoice.id!); as collectionForm) {
                    <form [formGroup]="collectionForm">
                      <select formControlName="collection_status" class="form-input collection-select">
                        @for (status of collectionStatusLabels; track status.value) {
                          <option [value]="status.value">{{ status.label }}</option>
                        }
                      </select>
                    </form>
                  }
                }
              </td>

              <!-- PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <span class="collection-method-display">
                    {{ invoicesUtilService.getMethodLabel(invoice.collection_method || 'transfer') }}
                  </span>
                } @else {
                  @if (getCollectionFormGroup(invoice.id!); as collectionForm) {
                    <form [formGroup]="collectionForm!">
                      <select
                        formControlName="collection_method" class="form-input collection-select">
                        @for (metho of collectionMethodLabels; track metho.value) {
                          <option [value]="metho.value">{{ metho.label }}</option>
                        }
                      </select>
                    </form>
                  }


                }
              </td>

              <!-- FECHA DE PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <span class="collection-date-display">
                    {{ invoice.collection_date ? (invoice.collection_date! | dataFormat) : '-' }}
                  </span>
                } @else {
                  @if (getCollectionFormGroup(invoice.id!); as collectionForm) {
                    <form [formGroup]="collectionForm!">
                      <input type="date" formControlName="collection_date" class="form-input collection-date-input">
                    </form>
                  }


                }
              </td>

              <!-- ABONOS -->
              <td>
                @if (invoice.is_refund === 1) {
                  <span class="status-abonado">Abonado</span>
                }
              </td>

              <!-- FACTURA ORIGINAL -->
              <td class="original-cell">{{ invoice.original_invoice_number || '-' }}</td>

              <!-- ACCIONES -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <button class="action-btn pdf-btn" (click)="downloadPdf(invoice.id!)">üìÑ PDF</button>
                  <button class="action-btn pay-btn" (click)="openRefundModal(invoice)">üí∞ Abonar</button>
                  <button class="action-btn edit-btn" (click)="editInvoice(invoice.id!)">‚úèÔ∏è Editar</button>
                } @else {
                  <button
                    class="action-btn save-btn"
                    (click)="saveCollectionChanges(invoice.id!)"
                    title="Guardar cambios">
                    ‚úÖ Guardar
                  </button>
                  <button
                    class="action-btn cancel-btn"
                    (click)="cancelEditingCollection(invoice.id!)"
                    title="Cancelar">
                    ‚ùå Cancelar
                  </button>
                }
              </td>
            </tr>
          }
        } @else {
          <tr>
            <td colspan="19" class="no-data">
              <div class="empty-state">
                <p>No se encontraron facturas</p>
                <button class="new-client-btn" (click)="createNewInvoice()">
                  + Nueva Factura
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>

    </table>
  </div>


  <!-- Paginaci√≥n -->
  @if (paginationResult.totalPages > 1) {
    <div class="pagination-container">

      <!-- Informaci√≥n de resultados -->
      <div class="pagination-info">
        {{ getPaginationText() }}
      </div>

      <!-- Controles de paginaci√≥n -->
      <div class="pagination-controls">

        <!-- Bot√≥n anterior -->
        <button
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasPrevious"
          (click)="previousPage()"
          [disabled]="!paginationResult.hasPrevious"
        >
          ‚Äπ Anterior
        </button>

        <!-- N√∫meros de p√°gina -->
        @for (page of getVisiblePages(); track page) {
          <button
            class="pagination-btn"
            [class.active]="page === paginationConfig.currentPage"
            (click)="goToPage(page)"
          >
            {{ page }}
          </button>
        }

        <!-- Puntos suspensivos si hay m√°s p√°ginas -->
        @if (paginationResult.totalPages > 5 && paginationConfig.currentPage < paginationResult.totalPages - 2) {
          <span class="pagination-dots">...</span>
        }

        <!-- √öltima p√°gina -->
        @if (paginationResult.totalPages > 5 && paginationConfig.currentPage < paginationResult.totalPages - 2) {
          <button
            class="pagination-btn"
            (click)="goToPage(paginationResult.totalPages)"
          >
            {{ paginationResult.totalPages }}
          </button>
        }
        <!-- Bot√≥n siguiente -->
        <button
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasNext"
          (click)="nextPage()"
          [disabled]="!paginationResult.hasNext"
        >
          Siguiente ‚Ä∫
        </button>

      </div>
    </div>
  }
  <!-- Modal de Abonos -->
  @if (showRefundModal) {
    <div class="modal-overlay" (click)="closeRefundModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">

        <div class="modal-header">
          <h3>üí∞ Registrar Abono</h3>
          <button class="close-btn" (click)="closeRefundModal()">√ó</button>
        </div>

        <div class="modal-body">
          <p><strong>Factura:</strong> {{ selectedInvoice?.invoice_number }}</p>
          <p><strong>Total:</strong> {{ selectedInvoice?.total | currency:'EUR':'symbol':'1.2-2' }}</p>

          <form [formGroup]="refundForm" (ngSubmit)="saveRefund()">
            <div class="form-field">
              <label class="form-label">Monto del Abono (‚Ç¨) *</label>
              <input
                type="number"
                formControlName="amount"
                name="amount"
                step="0.01"
                min="0.01"
                class="form-input"
                required>
            </div>

            <div class="form-field">
              <label class="form-label">Fecha *</label>
              <input
                type="date"
                formControlName="invoice_date"
                name="bill_date"
                class="form-input"
                required>
            </div>

            <div class="form-field">
              <label class="form-label">M√©todo de Pago (referencia)</label>
              <select formControlName="collection_method" class="form-input">
                @for (method of collectionMethodLabels; track method.value) {
                  <option [value]="method.value">{{ method.label }}</option>
                }
              </select>
            </div>

            <div class="form-field">
              <label class="form-label">Concepto del Abono</label>
              <textarea
                formControlName="concept"
                name="concept"
                rows="3"
                placeholder="Abono por..."
                class="form-input">
              </textarea>
            </div>

            <div class="modal-buttons">
              <button type="button" class="secondary-btn" (click)="closeRefundModal()">
                Cancelar
              </button>
              <button type="submit" class="primary-btn" [disabled]="refundForm.invalid">
                Guardar Abono
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
