<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Gesti√≥n de Facturas</h1>
    <p class="subtitle">Administra el listado completo de facturas emitidas</p>
  </div>

  <!-- Secci√≥n de filtros y b√∫squeda -->
  <div class="filters-section">

    <!-- Buscador CON ICONOS -->
    <div class="search-container">
      <div class="search-wrapper">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onFilterCharger()"
          placeholder="Buscar por n√∫mero de factura, cliente, propietario..."
          class="search-input"
          autocomplete="off">

        <!-- Iconos de b√∫squeda y limpiar -->
        <div class="search-actions">
          <span class="search-icon">üîç</span>
          @if (searchTerm && searchTerm.trim() !== '') {
            <button
              type="button"
              (click)="clearFilters()"
              class="clear-button"
              title="Limpiar b√∫squeda">
              ‚úï
            </button>
          }
        </div>

      </div>
    </div>

    <!-- Filtro estado de facturas-->
    <div class="filters-container">
      <select [(ngModel)]="selectedCollectionStatus"
              (change)="onFilterCharger()" class="filter-select">
        <option value="">Tipos de Factura</option>
        @for (status of collectionStatusOptions; track status) {
          <option [value]="status">{{ collectionStatusLabels[status] }}</option>
        }
      </select>
    </div>

    <!-- Filtro de facturas de abono-->
    <div class="filters-container">
      <select [(ngModel)]="selectedRefundStatus"
              (change)="onFilterCharger()" class="filter-select">
        <option value="">Por Factura</option>
        @for ( refunds of refundStatusOptions; track refunds.value) {
          <option [value]="refunds.value">{{refunds.label}}</option>

        }
      </select>
    </div>



    <!-- Filtro de facturas por mes o proporcional-->
    <div class="filters-container">
      <select [(ngModel)]="selectedTypeBilling"
              (change)="onFilterCharger()" class="filter-select">
        <option value="">Por Facturaci√≥n</option>
        @for (typesBill of billingTypeOptions; track typesBill){
          <option [value]="typesBill">{{billingTypeLabels[typesBill]}}</option>
        }
      </select>
    </div>

    <!-- Filtro de factura por propietarios-->
    <div class="filters-container">
      <select [(ngModel)]="selectedOwners"
              (change)="onFilterCharger()" class="filter-select">
        <option value="">Por Propietarios</option>
        @for (owner of ownersOptions; track owner){
          <option [value]="owner">{{owner}}</option>
        }
      </select>

      <!-- Filtro de facturas por cliente-->
      <div class="filters-container">
        <select [(ngModel)]="selectedClients"
                (change)="onFilterCharger()" class="filter-select">
          <option value="">Por Cliente</option>
          @for (client of clientsOptions; track client){
            <option [value]="client">{{client}}</option>
          }
        </select>
      </div>

    </div>



    <!-- Bot√≥n nueva factura -->
    <div class="actions-container">
      <button class="export-btn">Exportar</button>
      <button class="new-invoice-btn" (click)="createNewInvoice()">+ Nueva Factura</button>
    </div>

  </div>

  <!-- Tabla de facturas -->
  <div class="table-container">
    <table class="clients-table">

      <!-- Cabecera -->
      <thead>
      <tr>
        <th>ID</th>
        <th>N¬∫ FACTURA</th>
        <th>PROPIEDAD</th>
        <th>CLIENTE</th>
        <th>PROPIETARIO</th>
        <th>FECHA</th>
        <th>BASE</th>
        <th>IVA</th>
        <th>IRPF</th>
        <th>TOTAL</th>
        <th>TIPO FACTURACI√ìN</th>
        <th>PER√çODO</th>
        <th>MES CORRESPONDIENTE</th>
        <th>ESTADO PAGO</th>
        <th>M√âTODO PAGO</th>
        <th>FECHA PAGO</th>
        <th>ABONOS</th>
        <th>FACTURA DE ABONADA</th>
        <th>ACCIONES</th>
      </tr>
      </thead>

      <!-- Cuerpo de la tabla -->
      <tbody>
        @if (invoices && invoices.length > 0) {
          @for (invoice of invoices; track invoice.id) {
            <tr>
              <td>#{{ invoice.id }}</td>
              <td class="invoice-number-cell">{{ invoice.invoice_number }}</td>
              <td title="ID: {{ invoice.estates_id }}">{{ invoice.estate_name }}</td>
              <td class="client-cell" title="ID: {{invoice.clients_id}}">{{ invoice.client_name }}</td>
              <td class="owner-cell" title="ID: {{invoice.owners_id}}">{{ invoice.owner_name }}</td>
              <td>{{ invoice.invoice_date | dataFormat }}</td>
              <td class="currency-cell">{{ invoice.tax_base | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td class="tax-cell">{{ invoice.iva }}%</td>
              <td class="tax-cell">{{ invoice.irpf }}%</td>
              <td class="total-cell">{{ invoice.total | currency:'EUR':'symbol':'1.2-2' }}</td>

              <!-- TIPO DE FACTURACI√ìN -->
              <td>
                <span
                  [ngClass]="invoiceUtilsService.isInvoiceProportional(invoice) ? 'proportional-badge' : 'normal-badge'">
                  @if (invoiceUtilsService.isInvoiceProportional(invoice)) {
                    üìä {{ billingTypeLabels[1] }}
                  } @else {
                    üìÑ {{ billingTypeLabels[0] }}
                  }
                </span>
              </td>

              <!-- PER√çODO -->
              <td>
                @if (invoiceUtilsService.isInvoiceProportional(invoice)) {
                  <span class="proportional-period" [title]="invoiceUtilsService.getProportionalDays(invoice)">
                    {{ invoiceUtilsService.getProportionalPeriod(invoice) }}
                  </span>
                } @else {
                  <span class="normal-period">Mes completo</span>
                }
              </td>

              <!-- MES CORRESPONDENCIA -->
              <td>
                <span class="corresponding-month">
                  {{ invoiceUtilsService.getCorrespondingMonthDisplay(invoice) }}
                </span>
              </td>

              <!-- ESTADO DE PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <div class="collection-status-container">
                    <span
                      [ngClass]="invoice.collection_status === 'collected' ? 'paid-badge' : 'pending-badge'"
                      (click)="toggleCollectionStatus(invoice)"
                      title="Clic para cambiar estado">
                      {{ collectionStatusLabels[invoice.collection_status || 'pending'] }}
                    </span>
                    <button
                      class="edit-payment-btn"
                      (click)="startEditingCollection(invoice)"
                      title="Editar detalles">
                      ‚úèÔ∏è
                    </button>
                  </div>
                } @else {
                  <select
                    [(ngModel)]="editingCollection[invoice.id!].collection_status"
                    class="form-input collection-select">
                    <option value="pending">Pendiente</option>
                    <option value="paid">Pagado</option>
                  </select>
                }
              </td>

              <!-- PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <span class="collection-method-display">
                    {{ collectionMethodLabels[invoice.collection_method || 'transfer'] }}
                  </span>
                } @else {
                  <select
                    [(ngModel)]="editingCollection[invoice.id!].collection_method"
                    class="form-input collection-select">
                    <option value="transfer">Transferencia</option>
                    <option value="direct_debit">Domiciliado</option>
                    <option value="cash">Efectivo</option>
                    <option value="card">Tarjeta</option>
                  </select>
                }
              </td>

              <!-- FECHA DE PAGO -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <span class="collection-date-display">
                    {{ invoice.collection_date ? (invoice.collection_date! | dataFormat) : '-' }}
                  </span>
                } @else {
                  <input
                    type="date"
                    [(ngModel)]="editingCollection[invoice.id!].collection_date"
                    class="form-input collection-date-input">
                }
              </td>

              <!-- ABONOS -->
              <td>
                @if (invoice.is_refund === 1) {
                  <span class="status-abonado">Abonado</span>
                }
              </td>

              <!-- FACTURA ORIGINAL -->
              <td class="original-cell">{{ invoice.original_invoice_number || '-' }}</td>

              <!-- ACCIONES -->
              <td>
                @if (!isEditingCollection(invoice.id!)) {
                  <button class="action-btn pdf-btn" (click)="downloadPdf(invoice.id!)">üìÑ PDF</button>
                  <button class="action-btn pay-btn" (click)="openRefundModal(invoice)">üí∞ Abonar</button>
                  <button class="action-btn edit-btn" (click)="editInvoice(invoice.id!)">‚úèÔ∏è Editar</button>
                } @else {
                  <button
                    class="action-btn save-btn"
                    (click)="saveCollectionChanges(invoice.id!)"
                    title="Guardar cambios">
                    ‚úÖ Guardar
                  </button>
                  <button
                    class="action-btn cancel-btn"
                    (click)="cancelEditingCollection(invoice.id!)"
                    title="Cancelar">
                    ‚ùå Cancelar
                  </button>
                }
              </td>
            </tr>
          }
        } @else {
          <tr>
            <td colspan="19" class="no-data">
              <div class="empty-state">
                <p>No se encontraron facturas</p>
                <button class="new-client-btn" (click)="createNewInvoice()">
                  + Nueva Factura
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>

    </table>
  </div>


  <!-- Paginaci√≥n -->
  @if (paginationResult.totalPages > 1) {
    <div class="pagination-container">

      <!-- Informaci√≥n de resultados -->
      <div class="pagination-info">
        {{ getPaginationText() }}
      </div>

      <!-- Controles de paginaci√≥n -->
      <div class="pagination-controls">

        <!-- Bot√≥n anterior -->
        <button
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasPrevious"
          (click)="previousPage()"
          [disabled]="!paginationResult.hasPrevious"
        >
          ‚Äπ Anterior
        </button>

        <!-- N√∫meros de p√°gina -->
        @for (page of getVisiblePages(); track page) {
          <button
            class="pagination-btn"
            [class.active]="page === paginationConfig.currentPage"
            (click)="goToPage(page)"
          >
            {{ page }}
          </button>
        }

        <!-- Puntos suspensivos si hay m√°s p√°ginas -->
        @if (paginationResult.totalPages > 5 && paginationConfig.currentPage < paginationResult.totalPages - 2) {
          <span class="pagination-dots">...</span>
        }

        <!-- √öltima p√°gina -->
        @if (paginationResult.totalPages > 5 && paginationConfig.currentPage < paginationResult.totalPages - 2) {
          <button
            class="pagination-btn"
            (click)="goToPage(paginationResult.totalPages)"
          >
            {{ paginationResult.totalPages }}
          </button>
        }
        <!-- Bot√≥n siguiente -->
        <button
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasNext"
          (click)="nextPage()"
          [disabled]="!paginationResult.hasNext"
        >
          Siguiente ‚Ä∫
        </button>

      </div>
    </div>
  }
  <!-- Modal de Abonos -->
  @if (showRefundModal) {
    <div class="modal-overlay" (click)="closeRefundModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">

        <div class="modal-header">
          <h3>üí∞ Registrar Abono</h3>
          <button class="close-btn" (click)="closeRefundModal()">√ó</button>
        </div>

        <div class="modal-body">
          <p><strong>Factura:</strong> {{ selectedInvoice?.invoice_number }}</p>
          <p><strong>Total:</strong> {{ selectedInvoice?.total | currency:'EUR':'symbol':'1.2-2' }}</p>

          <form (ngSubmit)="saveRefund()">
            <div class="form-field">
              <label class="form-label">Monto del Abono (‚Ç¨) *</label>
              <input
                type="number"
                [(ngModel)]="newRefund.amount"
                name="amount"
                step="0.01"
                min="0.01"
                class="form-input"
                required>
            </div>

            <div class="form-field">
              <label class="form-label">Fecha *</label>
              <input
                type="date"
                [(ngModel)]="newRefund.invoice_date"
                name="bill_date"
                class="form-input"
                required>
            </div>

            <div class="form-field">
              <label class="form-label">M√©todo de Pago (referencia)</label>
              <select [(ngModel)]="newRefund.collection_method" name="collection_method" class="form-input">
                <option value="transfer">Transferencia</option>
                <option value="cash">Efectivo</option>
                <option value="card">Tarjeta</option>
                <option value="check">Cheque</option>
              </select>
            </div>

            <div class="form-field">
              <label class="form-label">Concepto del Abono</label>
              <textarea
                [(ngModel)]="newRefund.concept"
                name="concept"
                rows="3"
                placeholder="Abono por..."
                class="form-input">
              </textarea>
            </div>

            <div class="modal-buttons">
              <button type="button" class="secondary-btn" (click)="closeRefundModal()">
                Cancelar
              </button>
              <button type="submit" class="primary-btn">
                Guardar Abono
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
