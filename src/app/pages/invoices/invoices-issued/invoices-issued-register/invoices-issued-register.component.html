<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Crear Factura</h1>
    <p class="subtitle">Registrar nueva factura en el sistema</p>
  </div>

  <!-- Formulario principal -->
  <form (ngSubmit)="registerInvoice()">

    <!-- Secci√≥n: Identificaci√≥n -->
    <div class="section">
      <h2 class="section-title">üìÑ Identificaci√≥n de la Factura</h2>
      <div class="form-grid">

        <div class="form-field form-field-full">
          <label for="invoices" class="form-label">N√∫mero de Factura (autom√°tico)</label>
          <input
            type="text"
            disabled
            id="invoices"
            class="form-input invoice-number-input"
            placeholder="Se generar√° autom√°ticamente">
        </div>

        <div class="form-field">
          <label for="fecha" class="form-label">Fecha *</label>
          <input
            type="date"
            [(ngModel)]="invoice.invoice_date"
            name="date"
            id="fecha"
            class="form-input"
            required>
        </div>

      </div>
    </div>

    <!-- Secci√≥n: Selecci√≥n de entidades -->
    <div class="section">
      <h2 class="section-title">üè¢ Entidades Relacionadas</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="estate" class="form-label">Propiedad *</label>
          <select
            required
            [(ngModel)]="invoice.estates_id"
            name="estate_id"
            id="estate"
            class="form-input">
            <option value="" disabled>Selecciona una propiedad</option>
            @for (estate of estates; track estate.id) {
              <option [value]="estate.id">
                {{ estate.address }} - {{ estate.cadastral_reference }}
              </option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="clients" class="form-label">Cliente *</label>
          <select
            required
            [(ngModel)]="invoice.clients_id"
            name="client_id"
            id="clients"
            class="form-input">
            <option value="" disabled>Selecciona un cliente</option>
            @for (client of clients; track client.id) {
              <option [value]="client.id">
                {{ client.name }} {{ client.lastname }}
              </option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="owners" class="form-label">Propietario *</label>
          <select
            required
            [(ngModel)]="invoice.owners_id"
            name="owner_id"
            id="owners"
            class="form-input">
            <option value="" disabled>Selecciona un propietario</option>
            @for (owner of owners; track owner.id) {
              <option [value]="owner.id">
                {{ owner.name }} {{ owner.lastname }}
              </option>
            }
          </select>
        </div>

      </div>
    </div>

    <!-- Secci√≥n: C√°lculos financieros -->
    <div class="section">
      <h2 class="section-title">üí∞ C√°lculos Financieros</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="tax_base" class="form-label">Base Imponible (‚Ç¨) *</label>
          <input
            type="number"
            [(ngModel)]="invoice.tax_base"
            name="tax_base"
            id="tax_base"
            (input)="onTaxBaseChange()"
            step="0.01"
            min="0"
            placeholder="0.00"
            class="form-input currency-input"
            required>
        </div>

        <div class="form-field">
          <label for="iva" class="form-label">IVA (%)</label>
          <input
            type="number"
            [(ngModel)]="invoice.iva"
            name="iva"
            id="iva"
            (input)="onIvaChange()"
            step="0.01"
            min="0"
            max="100"
            placeholder="21.00"
            class="form-input percentage-input">
        </div>

        <div class="form-field">
          <label for="irpf" class="form-label">IRPF (%)</label>
          <input
            type="number"
            [(ngModel)]="invoice.irpf"
            name="irpf"
            id="irpf"
            (input)="onIrpfChange()"
            step="0.01"
            min="0"
            max="100"
            placeholder="15.00"
            class="form-input percentage-input">
        </div>

        <div class="form-field">
          <label for="total" class="form-label">Total (‚Ç¨)</label>
          <input
            type="number"
            [(ngModel)]="invoice.total"
            name="total"
            id="total"
            readonly
            class="form-input total-input"
            placeholder="Calculado autom√°ticamente">
        </div>

      </div>
    </div>

    <!-- Secci√≥n: Tipo de Facturaci√≥n -->
    <div class="section">
      <h2 class="section-title">üìä Tipo de Facturaci√≥n</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="is_proportional" class="form-label">Tipo de Facturaci√≥n</label>
          <select
            [(ngModel)]="invoice.is_proportional"
            name="is_proportional"
            id="is_proportional"
            (change)="onBillingTypeChange()"
            class="form-input billing-type-select">
            <option [value]="0">{{ billingTypeLabels[0] }}</option>
            <option [value]="1">{{ billingTypeLabels[1] }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="corresponding_month" class="form-label">Mes de Correspondencia</label>
          <input
            type="month"
            [(ngModel)]="invoice.corresponding_month"
            name="corresponding_month"
            id="corresponding_month"
            class="form-input month-input"
            placeholder="Ej: 2025-06 para Junio 2025">
          <small class="help-text">
            Opcional: Para indicar a qu√© mes corresponde esta factura
          </small>
        </div>

        <!-- Campos proporcionales (solo si est√° seleccionado) -->
        @if (invoice.is_proportional == 1) {
          <div class="form-field">
            <label for="start_date" class="form-label">
              Fecha de Inicio *
              <span class="required-indicator">*</span>
            </label>
            <input
              type="date"
              [(ngModel)]="invoice.start_date"
              name="start_date"
              id="start_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input"
              required>
          </div>

          <div class="form-field">
            <label for="end_date" class="form-label">
              Fecha de Fin *
              <span class="required-indicator">*</span>
            </label>
            <input
              type="date"
              [(ngModel)]="invoice.end_date"
              name="end_date"
              id="end_date"
              (change)="onProportionalDatesChange()"
              class="form-input proportional-date-input"
              required>
          </div>
        }

      </div>

      <!-- Informaci√≥n de simulaci√≥n proporcional -->
      @if (simulationResult) {
        <div class="proportional-summary">
          <h4>üßÆ C√°lculo Proporcional</h4>
          <div class="proportional-details">
            <div class="detail-item">
              <span class="detail-label">Per√≠odo:</span>
              <span class="detail-value">{{ simulationResult.periodDescription }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">D√≠as facturados:</span>
              <span class="detail-value">{{ simulationResult.details.days_billed }}
                de {{ simulationResult.details.days_in_month }} d√≠as</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Porcentaje:</span>
              <span class="detail-value">{{ simulationResult.details.proportion_percentage }}%</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Base original:</span>
              <span class="detail-value">{{ simulationResult.details.original_base | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Base proporcional:</span>
              <span class="detail-value">{{ simulationResult.details.proportional_base | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
            <div class="detail-item total-line">
              <span class="detail-label">Total proporcional:</span>
              <span class="detail-value">{{ simulationResult.total | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      }

      <!-- Estado de carga durante simulaci√≥n -->
      @if (isSimulating) {
        <div class="loading-state">
          <span>üîÑ Calculando facturaci√≥n proporcional...</span>
        </div>
      }
    </div>

    <!-- Secci√≥n: Informaci√≥n de Pago -->
    <div class="section">
      <h2 class="section-title">üí≥ Informaci√≥n de Pago</h2>
      <div class="form-grid">

        <div class="form-field">
          <label for="collection_status" class="form-label">Estado de Pago</label>
          <select
            [(ngModel)]="invoice.collection_status"
            name="collection_status"
            id="collection_status"
            (change)="onCollectionStatusChange()"
            class="form-input payment-status-select">
            <option value="pending">{{ collectionStatusLabels.pending }}</option>
            <option value="collected">{{ collectionStatusLabels.collected }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="collection_method" class="form-label">M√©todo de Pago</label>
          <select
            [(ngModel)]="invoice.collection_method"
            name="collection_method"
            id="collection_method"
            class="form-input collection-method-select">
            <option value="transfer">{{ collectionMethodLabels.transfer }}</option>
            <option value="direct_debit">{{ collectionMethodLabels.direct_debit }}</option>
            <option value="cash">{{ collectionMethodLabels.cash }}</option>
            <option value="card">{{ collectionMethodLabels.card }}</option>
          </select>
        </div>

        <div class="form-field">
          <label for="collection_date" class="form-label">
            Fecha de Pago
            @if (invoice.collection_status === 'collected') {
              <span class="required-indicator">*</span>
            }
          </label>
          <input
            type="date"
            [(ngModel)]="invoice.collection_date"
            name="collection_date"
            id="collection_date"
            class="form-input collection-date-input"
            [required]="invoice.collection_status === 'collected'"
            [disabled]="invoice.collection_status === 'pending'"
            placeholder="Fecha en que se realiz√≥ el pago">
          @if (invoice.collection_status === 'pending') {
            <small class="help-text">
              Se habilitar√° al marcar como "Pagado"
            </small>
          }
        </div>

        <div class="form-field form-field-full">
          <label for="collection_notes" class="form-label">Notas del Pago (opcional)</label>
          <textarea
            [(ngModel)]="invoice.collection_notes"
            name="collection_notes"
            id="collection_notes"
            rows="3"
            class="form-input collection-notes-textarea"
            placeholder="Ej: N√∫mero de transferencia, referencia del pago, observaciones...">
          </textarea>
        </div>

      </div>

      <!-- Informaci√≥n visual del estado -->
      <div class="collection-summary">
        <div class="collection-summary-item">
          <span class="collection-summary-label">Estado:</span>
          <span class="collection-summary-value"
                [class.status-pending]="invoice.collection_status === 'pending'"
                [class.status-paid]="invoice.collection_status === 'collected'">
            {{ collectionStatusLabels[invoice.collection_status || 'pending'] }}
          </span>
        </div>
        <div class="collection-summary-item">
          <span class="collection-summary-label">M√©todo:</span>
          <span class="collection-summary-value">
            {{ collectionMethodLabels[invoice.collection_method || 'transfer'] }}
          </span>
        </div>
        @if (invoice.collection_date) {
          <div class="collection-summary-item">
            <span class="collection-summary-label">Fecha de Pago:</span>
            <span class="collection-summary-value">{{ invoice.collection_date }}</span>
          </div>
        }
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="actions-section">
      <button type="submit" class="primary-btn">
        üí∞ Crear Factura
      </button>
      <button type="button" class="secondary-btn" (click)="goBack()">
        ‚Üê Cancelar
      </button>
    </div>

  </form>
</div>
