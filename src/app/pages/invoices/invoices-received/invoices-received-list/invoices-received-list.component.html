<div class="container">
  <!-- T√≠tulo y descripci√≥n -->
  <div class="header">
    <h1 class="title">Gesti√≥n de Facturas Recibidas</h1>
    <p class="subtitle">Administra el listado completo de facturas de proveedores</p>
  </div>

  <!-- Secci√≥n de b√∫squeda -->
  <div class="filters-section">
    <form class="search-container" [formGroup]="searchForm">
      <div class="search-wrapper">
        <input
          type="text"
          formControlName="searchTerm"
          placeholder="Buscar por n√∫mero de factura, proveedor, categor√≠a..."
          class="search-input"
          autocomplete="off">
        <div class="search-actions">
          <span class="search-icon">üîç</span>
          @if (searchForm.get('searchTerm')?.value) {
            <button type="button" (click)="clearFilters()" class="clear-button" title="Limpiar b√∫squeda">‚úï</button>
          }
        </div>
      </div>
    </form>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <form [formGroup]="filtersForm">
      <!-- Estado de pago -->
      <select formControlName="selectedPaymentStatus" class="filter-select">
        <option value="">Estado de Pago</option>
        @for (status of paymentStatusLabels; track status.value) {
          <option [value]="status.value">{{ status.label }}</option>
        }
      </select>

      <!-- Tipo de factura -->
      <select formControlName="selectedRefundStatus" class="filter-select">
        <option value="">Por Tipo</option>
        @for (refund of refundStatusOptions; track refund.value) {
          <option [value]="refund.value">{{ refund.label }}</option>
        }
      </select>

      <!-- Categor√≠a -->
      <select formControlName="selectedCategory" class="filter-select">
        <option value="">Por Categor√≠a</option>
        @for (category of categoryOptions; track category) {
          <option [value]="category">{{ category }}</option>
        }
      </select>

      <!-- Proveedor -->
      <select formControlName="selectedSupplier" class="filter-select">
        <option value="">Por Proveedor</option>
        @for (supplier of suppliersOptions; track supplier) {
          <option [value]="supplier">{{ supplier }}</option>
        }
      </select>

      <!-- Bot√≥n limpiar filtros -->
      <button
        type="button"
        (click)="clearFilters()"
        class="clear-filters-btn"
        title="Limpiar todos los filtros">
        Limpiar filtros
      </button>
    </form>

    <!-- Botones de acci√≥n -->
    <div class="actions-container">
      <button type="button" class="export-btn" (click)="exportData()">
        Exportar Todo
      </button>
      <button type="button" class="export-btn" (click)="exportCurrentPage()">
        Exportar P√°gina
      </button>
      <button type="button" class="export-btn" (click)="exportSelected()">
        Exportar Selecci√≥n ({{ selectedItems.size }})
      </button>
      <button type="button" class="primary-btn" (click)="createNewInvoice()">+ Nueva Factura Recibida</button>
    </div>
  </div>

  <!-- Configuraci√≥n de paginaci√≥n -->
  <div class="pagination-config">
    <form [formGroup]="paginationForm">
      <label for="itemsPerPage">Elementos por p√°gina:</label>
      <select
        id="itemsPerPage"
        formControlName="itemsPerPage"
        class="items-per-page-select">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
    </form>
  </div>

  <!-- Tabla de facturas recibidas -->
  <div class="table-container">
    <table class="data-table">
      <!-- Cabecera -->
      <thead>
      <tr>

        <th>
          <input
            type="checkbox"
            (change)="toggleAllSelection()"
            [checked]="isAllSelected()">
        </th>

        <th>ID</th>
        <th>N¬∫ FACTURA</th>
        <th>REFERENCIA</th>
        <th>PROVEEDOR</th>
        <th>FECHA FACTURA</th>
        <th>FECHA VENCIMIENTO</th>
        <th>BASE</th>
        <th>IVA</th>
        <th>IRPF</th>
        <th>TOTAL</th>
        <th>CATEGOR√çA</th>
        <th>DESCRIPCI√ìN</th>
        <th>ESTADO PAGO</th>
        <th>M√âTODO PAGO</th>
        <th>FECHA PAGO</th>
        <th>ABONOS</th>
        <th>FACTURA ORIGINAL</th>
        <th>ADJUNTO</th>
        <th>ACCIONES</th>
      </tr>
      </thead>

      <!-- Cuerpo de la tabla -->
      <tbody>
        @if (invoices && invoices.length > 0) {
          @for (invoice of invoices; track invoice.id) {
            <tr>

              <td>
                <input
                  type="checkbox"
                  [checked]="selectedItems.has(invoice.id!)"
                  (change)="toggleSelection(invoice.id!)">
              </td>

              <td>#{{ invoice.id }}</td>
              <td class="tax-id-cell">{{ invoice.invoice_number }}</td>
              <td class="tax-id-cell">{{ invoice.our_reference }}</td>
              <td class="name-cell" title="CIF: {{ invoice.supplier_tax_id }}">
                {{ invoice.supplier_name }}
              </td>
              <td>{{ invoice.invoice_date | dataFormat }}</td>
              <td [class.inactive-row]="invoicesUtilService.isOverdue(invoice)">
                {{ invoice.due_date | dataFormat }}
              </td>
              <td class="payment-terms-cell">{{ invoice.tax_base | number:'1.2-2' }}‚Ç¨</td>
              <td class="payment-terms-cell">{{ invoice.iva_percentage }}%</td>
              <td class="payment-terms-cell">{{ invoice.irpf_percentage }}%</td>
              <td class="payment-terms-cell">{{ invoice.total_amount | number:'1.2-2' }}‚Ç¨</td>

              <!-- CATEGOR√çA -->
              <td>
                <span [ngClass]="invoicesUtilService.getCategoryClass(invoice.category)">
                  {{ invoicesUtilService.getCategoryLabel(invoice.category!) || invoice.category }}
                </span>
              </td>

              <!-- DESCRIPCI√ìN -->
              <td [title]="invoice.description">
                {{ invoicesUtilService.truncateText(invoice.description, 30) }}
              </td>

              <!-- ESTADO DE PAGO -->
              <td>
                @if (!isEditingPayment(invoice.id!)) {
                  <div class="payment-status-container">
                    <span [ngClass]="invoicesUtilService.getPaymentStatusClass(invoice.collection_status)"
                          (click)="togglePaymentStatus(invoice)"
                          title="Clic para cambiar estado">
                      {{ invoicesUtilService.getStatusLabel(invoice.collection_status || 'pending') }}
                    </span>
                    <button type="button" class="action-btn edit-btn" (click)="startEditingPayment(invoice)"
                            title="Editar detalles">
                      Editar
                    </button>
                  </div>
                } @else if (editPaymentForm) {
                  <div [formGroup]="editPaymentForm">
                    <select formControlName="collection_status" class="filter-select">
                      @for (status of paymentStatusLabels; track status.value) {
                        <option [value]="status.value">{{ status.label }}</option>
                      }
                    </select>
                  </div>
                }
              </td>

              <!-- M√âTODO DE PAGO -->
              <td>
                @if (!isEditingPayment(invoice.id!)) {
                  <span>
                    {{ invoicesUtilService.getMethodLabel(invoice.collection_method || 'transfer') }}
                  </span>
                } @else if (editPaymentForm) {
                  <div [formGroup]="editPaymentForm">
                    <select formControlName="collection_method" class="filter-select">
                      @for (method of paymentMethodLabels; track method.value) {
                        <option [value]="method.value">{{ method.label }}</option>
                      }
                    </select>
                  </div>
                }
              </td>

              <!-- FECHA DE PAGO -->
              <td>
                @if (!isEditingPayment(invoice.id!)) {
                  <span>
                    {{ invoice.collection_date ? (invoice.collection_date! | dataFormat) : '-' }}
                  </span>
                } @else if (editPaymentForm) {
                  <div [formGroup]="editPaymentForm">
                    <input type="date" formControlName="collection_date" class="filter-select">
                  </div>
                }
              </td>

              <!-- ABONOS -->
              <td>
                @if (invoice.is_refund) {
                  <span class="inactive-badge">Abono</span>
                }
              </td>

              <!-- FACTURA ORIGINAL -->
              <td>{{ invoice.original_invoice_number || '-' }}</td>

              <!-- ADJUNTO -->
              <td>
                @if (invoice.has_attachments) {
                  <button type="button" class="action-btn edit-btn" (click)="viewAttachment(invoice)" title="Ver archivo adjunto">
                    Ver PDF
                  </button>
                }
              </td>

              <!-- ACCIONES -->
              <td>
                @if (!isEditingPayment(invoice.id!)) {
                  <button type="button" class="action-btn edit-btn" (click)="downloadPdf(invoice.id!)">PDF</button>
                  <button type="button" class="action-btn activate-btn" (click)="openRefundModal(invoice)">Abonar
                  </button>
                  <button type="button" class="action-btn edit-btn" (click)="editInvoice(invoice.id!)">Editar</button>
                } @else {
                  <button
                    type="button"
                    class="action-btn activate-btn"
                    (click)="savePaymentChanges(invoice.id!)"
                    title="Guardar cambios">
                    Guardar
                  </button>
                  <button
                    type="button"
                    class="action-btn delete-btn"
                    (click)="cancelEditingPayment(invoice.id!)"
                    title="Cancelar">
                    Cancelar
                  </button>
                }
              </td>
            </tr>
          }
        } @else {
          <tr>
            <td colspan="18" class="no-data">
              <div class="empty-state">
                <p>No se encontraron facturas recibidas</p>
                <button type="button" class="primary-btn" (click)="createNewInvoice()">
                  + Nueva Factura Recibida
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>

    </table>
  </div>

  <!-- Paginaci√≥n -->
  @if (paginationResult.totalPages > 1) {
    <div class="pagination-container">

      <!-- Informaci√≥n de resultados -->
      <div class="pagination-info">
        {{ getPaginationText() }}
      </div>

      <!-- Controles de paginaci√≥n -->
      <div class="pagination-controls">

        <!-- Bot√≥n anterior -->
        <button
          type="button"
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasPrevious"
          (click)="previousPage()"
          [disabled]="!paginationResult.hasPrevious">
          ‚Äπ Anterior
        </button>

        <!-- N√∫meros de p√°gina -->
        @for (page of getVisiblePages(); track page) {
          <button
            type="button"
            class="pagination-btn"
            [class.active]="page === paginationConfig.currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        }

        <!-- Puntos suspensivos si hay m√°s p√°ginas -->
        @if (paginationResult.totalPages > 5 && paginationConfig.currentPage < paginationResult.totalPages - 2) {
          <span class="pagination-dots">...</span>
          <button
            type="button"
            class="pagination-btn"
            (click)="goToPage(paginationResult.totalPages)">
            {{ paginationResult.totalPages }}
          </button>
        }

        <!-- Bot√≥n siguiente -->
        <button
          type="button"
          class="pagination-btn"
          [class.disabled]="!paginationResult.hasNext"
          (click)="nextPage()"
          [disabled]="!paginationResult.hasNext">
          Siguiente ‚Ä∫
        </button>

      </div>
    </div>
  }

  <!-- Modal de Abonos -->
  @if (showRefundModal) {
    <div class="modal-overlay" (click)="closeRefundModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">

        <div class="modal-header">
          <h3>üí∞ Registrar Abono</h3>
          <button type="button" class="close-btn" (click)="closeRefundModal()">√ó</button>
        </div>

        <div class="modal-body">
          <p><strong>Factura:</strong> {{ selectedInvoice?.invoice_number }}</p>
          <p><strong>Proveedor:</strong> {{ selectedInvoice?.supplier_name }}</p>
          <p><strong>Total:</strong> {{ selectedInvoice?.total_amount | number:'1.2-2' }}‚Ç¨</p>

          <form [formGroup]="refundForm" (ngSubmit)="saveRefund()">
            <div class="form-field">
              <label class="form-label">Motivo del Abono *</label>
              <textarea
                formControlName="refundReason"
                rows="3"
                placeholder="Motivo del abono..."
                class="filter-select"
                [class.error]="refundForm.get('refundReason')?.invalid && refundForm.get('refundReason')?.touched">
              </textarea>
              @if (refundForm.get('refundReason')?.invalid && refundForm.get('refundReason')?.touched) {
                <span class="error-message">El motivo del abono es obligatorio</span>
              }
            </div>

            <div class="modal-buttons">
              <button type="button" class="clear-filters-btn" (click)="closeRefundModal()">
                Cancelar
              </button>
              <button type="submit" class="primary-btn" [disabled]="refundForm.invalid">
                Crear Abono
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
