<div class="container">
  <!-- Encabezado -->
  <div class="header">
    <h1 class="title">Registrar Factura Recibida</h1>
    <button class="back-btn" (click)="goBack()">‚Üê Volver</button>
  </div>

  <!-- Formulario -->
  <form [formGroup]="mainForm" (ngSubmit)="onSubmit()" class="invoice-form">

    <!-- Informaci√≥n B√°sica -->
    <div class="form-section" formGroupName="basicInfo">
      <h2 class="section-title">Informaci√≥n B√°sica</h2>

      <div class="form-row">
        <div class="form-field">
          <label class="form-label">Proveedor *</label>
          <select formControlName="supplier_id" class="form-input"
                  [class.error]="isFieldInvalid(basicInfoForm, 'supplier_id')">
            <option value="">Seleccionar proveedor</option>
            @for (supplier of suppliers; track supplier.id) {
              <option [value]="supplier.id">{{ supplier.company_name || supplier.name }}</option>
            }
          </select>
          @if (isFieldInvalid(basicInfoForm, 'supplier_id')) {
            <span class="error-message">El proveedor es obligatorio</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label">N√∫mero de Factura *</label>
          <input type="text" formControlName="invoice_number" class="form-input"
                 [class.error]="isFieldInvalid(basicInfoForm, 'invoice_number')" placeholder="FAC-2024-001">
          @if (isFieldInvalid(basicInfoForm, 'invoice_number')) {
            <span class="error-message">El n√∫mero de factura es obligatorio</span>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label class="form-label">Fecha de Factura *</label>
          <input type="date" formControlName="invoice_date" class="form-input"
                 [class.error]="isFieldInvalid(basicInfoForm, 'invoice_date')">
          @if (isFieldInvalid(basicInfoForm, 'invoice_date')) {
            <span class="error-message">La fecha es obligatoria</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label">Fecha de Vencimiento</label>
          <input type="date" formControlName="due_date" class="form-input">
        </div>
      </div>
    </div>

    <!-- Importes -->
    <div class="form-section" formGroupName="amounts">
      <h2 class="section-title">Importes</h2>

      <div class="form-row">
        <div class="form-field">
          <label class="form-label">Base Imponible *</label>
          <div class="input-group">
            <input type="number" formControlName="tax_base" class="form-input"
                   [class.error]="isFieldInvalid(amountsForm, 'tax_base')" placeholder="0.00"
                   step="0.01" min="0.01">
            <span class="input-suffix">‚Ç¨</span>
          </div>
          @if (isFieldInvalid(amountsForm, 'tax_base')) {
            <span class="error-message">La base imponible es obligatoria</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label">IVA (%)</label>
          <div class="input-group">
            <input type="number" formControlName="iva_percentage" class="form-input"
                   placeholder="21.00" step="0.01" min="0" max="100">
            <span class="input-suffix">%</span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">IRPF (%)</label>
          <div class="input-group">
            <input type="number" formControlName="irpf_percentage" class="form-input"
                   placeholder="0.00" step="0.01" min="0" max="100">
            <span class="input-suffix">%</span>
          </div>
        </div>
      </div>

      <!-- Total calculado -->
      <div class="total-display">
        <span class="total-label">Total:</span>
        <span class="total-amount">{{ calculatedTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
        <span class="total-label">Total Calculo:</span>
        <span class="total-amount">{{ amountsForm.get('total_amount')?.value | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
    </div>

    <!-- Categorizaci√≥n -->
    <div class="form-section" formGroupName="categories">
      <h2 class="section-title">Categorizaci√≥n</h2>

      <div class="form-row">
        <div class="form-field">
          <label class="form-label">Categor√≠a *</label>
          <select formControlName="category" class="form-input"
                  [class.error]="isFieldInvalid(categoriesForm, 'category')">
            <option value="">Seleccionar categor√≠a</option>
            @for (category of categories; track category.value) {
              <option [value]="category.value">{{ category.label }}</option>
            }
          </select>
          @if (isFieldInvalid(categoriesForm, 'category')) {
            <span class="error-message">La categor√≠a es obligatoria</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label">Subcategor√≠a</label>
          <input type="text" formControlName="subcategory" class="form-input"
                 placeholder="Ej: Consumo oficina">
        </div>
      </div>

      <div class="form-field">
        <label class="form-label">Descripci√≥n *</label>
        <textarea formControlName="description" class="form-input"
                  [class.error]="isFieldInvalid(categoriesForm, 'description')" rows="3"
                  placeholder="Descripci√≥n de la factura..."></textarea>
        @if (isFieldInvalid(categoriesForm, 'description')) {
          <span class="error-message">La descripci√≥n es obligatoria</span>
        }
      </div>
    </div>

    <!-- Archivo Adjunto -->
    <div class="form-section">
      <h2 class="section-title">Archivo Adjunto</h2>

      <div class="form-field">
        <label class="form-label">Adjuntar PDF de la Factura</label>

        <!-- Zona de arrastrar y soltar -->
        <div class="file-upload-area"
             [class.dragover]="isDragOver"
             [class.has-file]="selectedFile"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onFileDrop($event)"
             (click)="fileInput.click()">

          @if (!selectedFile) {
            <div class="upload-content">
              <div class="upload-icon">üìÑ</div>
              <p class="upload-text">Arrastra aqu√≠ el archivo PDF o haz clic para seleccionar</p>
              <p class="upload-hint">Formatos permitidos: PDF (m√°ximo 10MB)</p>
            </div>
          } @else {
            <div class="file-preview">
              <div class="file-info">
                <div class="file-icon">üìÑ</div>
                <div class="file-details">
                  <span class="file-name">{{ selectedFile.name }}</span>
                  <span class="file-size">{{ formatFileSize(selectedFile.size) }}</span>
                </div>
              </div>
              <button type="button" class="remove-file-btn" (click)="removeFile($event)">
                ‚úï
              </button>
            </div>
          }
        </div>

        <!-- Input oculto para seleccionar archivo -->
        <input #fileInput
               type="file"
               accept=".pdf"
               (change)="onFileSelected($event)"
               style="display: none;">

        @if (fileError) {
          <span class="error-message">{{ fileError }}</span>
        }
      </div>
    </div>

    <!-- Estado de Pago -->
    <div class="form-section" formGroupName="payment">
      <h2 class="section-title">Estado de Pago</h2>

      <div class="form-row">
        <div class="form-field">
          <label class="form-label">Estado</label>
          <select formControlName="payment_status" class="form-input">
            @for (status of paymentStatusLabels; track status.value) {
              <option [value]="status.value">{{ status.label }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label class="form-label">M√©todo de Pago</label>
          <select formControlName="payment_method" class="form-input">
            @for (method of paymentMethodLabels; track method.value) {
              <option [value]="method.value">{{ method.label }}</option>
            }
          </select>
        </div>

        @if (showPaymentFields) {
          <div class="form-field">
            <label class="form-label">Fecha de Pago</label>
            <input type="date" formControlName="payment_date" class="form-input">
          </div>
        }
      </div>

      @if (showPaymentFields) {
        <div class="form-field">
          <label class="form-label">Referencia de Pago</label>
          <input type="text" formControlName="payment_reference" class="form-input"
                 placeholder="Ej: TRF-001234">
        </div>
      }
    </div>

    <!-- Botones -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="goBack()">
        Cancelar
      </button>

      <button type="submit" class="btn btn-primary" [disabled]="!areAllFormsValid() || isSubmitting">
        @if (isSubmitting) {
          Guardando...
        } @else {
          Registrar Factura
        }
      </button>
    </div>

  </form>

</div>
